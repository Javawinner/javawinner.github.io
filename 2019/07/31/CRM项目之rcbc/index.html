<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>CRM项目之rcbc | Gorg Chen</title><meta name="description" content="CRM项目之rcbc"><meta name="keywords" content="django,CRM"><meta name="author" content="Gorg Chen"><meta name="copyright" content="Gorg Chen"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="canonical" href="http://cjwnb.top/2019/07/31/CRM项目之rcbc/"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="CRM项目之rcbc"><meta name="twitter:description" content="CRM项目之rcbc"><meta name="twitter:image" content="http://pic1.win4000.com/pic/1/dc/e2acd32b70.jpg"><meta property="og:type" content="article"><meta property="og:title" content="CRM项目之rcbc"><meta property="og:url" content="http://cjwnb.top/2019/07/31/CRM项目之rcbc/"><meta property="og:site_name" content="Gorg Chen"><meta property="og:description" content="CRM项目之rcbc"><meta property="og:image" content="http://pic1.win4000.com/pic/1/dc/e2acd32b70.jpg"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="prev" title="Stark组件（一）自动生成url" href="http://cjwnb.top/2019/07/31/Stark组件（一）自动生成url/"><link rel="next" title="面向对象" href="http://cjwnb.top/2019/07/31/面向对象/"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":1,"translateDelay":0,"cookieDomain":"https://jerryc.me/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight_copy: 'true',
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: '添加书签',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天'

  
}</script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#项目用到的基础知识"><span class="toc-number">1.</span> <span class="toc-text">项目用到的基础知识</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#orm操作"><span class="toc-number">1.1.</span> <span class="toc-text">orm操作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#正则表达式"><span class="toc-number">1.2.</span> <span class="toc-text">正则表达式</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#准备"><span class="toc-number">2.</span> <span class="toc-text">准备</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#目标"><span class="toc-number">3.</span> <span class="toc-text">目标</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#步骤"><span class="toc-number">4.</span> <span class="toc-text">步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#快速完成一个基本权限控制"><span class="toc-number">4.1.</span> <span class="toc-text">快速完成一个基本权限控制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#权限控制的基本流程"><span class="toc-number">4.1.1.</span> <span class="toc-text">权限控制的基本流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#用户登录"><span class="toc-number">4.1.2.</span> <span class="toc-text">用户登录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#编写中间件做权限信息校验"><span class="toc-number">4.1.3.</span> <span class="toc-text">编写中间件做权限信息校验</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#小坑"><span class="toc-number">4.1.4.</span> <span class="toc-text">小坑</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#为用户显示自己的菜单"><span class="toc-number">4.2.</span> <span class="toc-text">为用户显示自己的菜单</span></a></li></ol></li></ol></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(http://pic1.win4000.com/pic/1/dc/e2acd32b70.jpg)"><div id="page-header"><span class="pull-left"> <a class="blog_title" id="site-name" href="/">Gorg Chen</a></span><div class="open toggle-menu pull-right"><div class="menu-icon-first"></div><div class="menu-icon-second"></div><div class="menu-icon-third"></div></div><span class="pull-right menus"><div class="mobile_author_icon"><img class="lozad" data-src="/img/friend_404.gif" onerror="onerror=null;src='/img/friend_404.gif'"><div class="mobile_author-info__description"></div></div><hr><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a><script>document.body.addEventListener('touchstart', function(){ });</script></div></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title"><div class="posttitle">CRM项目之rcbc</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2019-07-31<span class="post-meta__separator">|</span><i class="fa fa-history" aria-hidden="true"></i> 更新于 2019-08-20</time><span class="post-meta__separator mobile_hidden">|</span><span class="mobile_hidden"><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/项目/">项目</a></span><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">1.3k</span><span class="post-meta__separator">|</span><span>阅读时长: 6 分钟</span><span class="post-meta__separator">|</span><span>阅读量: </span><span id="busuanzi_value_page_pv"></span></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><h1 id="项目用到的基础知识"><a href="#项目用到的基础知识" class="headerlink" title="项目用到的基础知识"></a>项目用到的基础知识</h1><h2 id="orm操作"><a href="#orm操作" class="headerlink" title="orm操作"></a>orm操作</h2><p><code>models.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Permission</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    权限表</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    title = models.CharField(verbose_name=<span class="string">'标题'</span>, max_length=<span class="number">32</span>)</span><br><span class="line">    url = models.CharField(verbose_name=<span class="string">'含正则的URL'</span>, max_length=<span class="number">128</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.title</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Role</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    角色</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    title = models.CharField(verbose_name=<span class="string">'角色名称'</span>, max_length=<span class="number">32</span>)</span><br><span class="line">    permissions = models.ManyToManyField(verbose_name=<span class="string">'拥有的所有权限'</span>, to=<span class="string">'Permission'</span>, blank=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.title</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    用户表</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    name = models.CharField(verbose_name=<span class="string">'用户名'</span>, max_length=<span class="number">32</span>)</span><br><span class="line">    password = models.CharField(verbose_name=<span class="string">'密码'</span>, max_length=<span class="number">64</span>)</span><br><span class="line">    email = models.CharField(verbose_name=<span class="string">'邮箱'</span>, max_length=<span class="number">32</span>)</span><br><span class="line">    roles = models.ManyToManyField(verbose_name=<span class="string">'拥有的所有角色'</span>, to=<span class="string">'Role'</span>, blank=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.name</span><br></pre></td></tr></table></figure>

<p><img src="http://hexoblog-image.oss-cn-shanghai.aliyuncs.com/permission%E8%A1%A8.png" alt="permission表"></p>
<p><img src="http://hexoblog-image.oss-cn-shanghai.aliyuncs.com/userinfo%E8%A1%A8.jpg" alt="UserInfo表"></p>
<p><img src="http://hexoblog-image.oss-cn-shanghai.aliyuncs.com/role%E8%A1%A8.jpg" alt="Role表"></p>
<p><img src="http://hexoblog-image.oss-cn-shanghai.aliyuncs.com/role-userinfo%E5%A4%9A%E5%AF%B9%E5%A4%9A%E5%85%B3%E7%B3%BB%E8%A1%A8.jpg" alt="UserInfo-Role多对多关系表"></p>
<p><img src="http://hexoblog-image.oss-cn-shanghai.aliyuncs.com/permission-role%E5%A4%9A%E5%AF%B9%E5%A4%9A%E5%85%B3%E7%B3%BB%E8%A1%A8.jpg" alt="permission-role 多对多关系表"></p>
<ul>
<li>获得luowen的所有权限</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>obj=models.UserInfo.objects.filter(name=<span class="string">'luowen'</span>,password=<span class="number">123</span>).first()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>obj.roles.filter(permissions__url__isnull=<span class="literal">False</span>).values(<span class="string">'id'</span>,<span class="string">'title'</span>,<span class="string">'permissions__url'</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>获得zhouzesb的所有权限</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>obj=models.UserInfo.objects.filter(name=<span class="string">'zhouzesb'</span>,password=<span class="number">123</span>).first()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>obj.roles.all().values(<span class="string">'permissions__url'</span>).distinct()</span><br></pre></td></tr></table></figure>

<ul>
<li>获得zhangfan的所有权限</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>obj=models.UserInfo.objects.filter(name=<span class="string">'zhangfan'</span>,password=<span class="number">123</span>).first()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>obj.roles.all().values(<span class="string">'permissions__url'</span>)</span><br></pre></td></tr></table></figure>

<h2 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">current_url = <span class="string">'/customer/edit/1/'</span></span><br><span class="line">error_url = <span class="string">'/customer/editssddssd/1/'</span></span><br><span class="line">error_url2 =<span class="string">'/customer/edit/1/sfsdsdsdsd'</span></span><br><span class="line"></span><br><span class="line">reg = <span class="string">'^/customer/edit/(\d+)/$'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">result_correct = re.match(reg, current_url)</span><br><span class="line">result_error = re.match(reg, error_url)</span><br><span class="line">result_error2=re.match(reg,error_url2)</span><br><span class="line">print(result_correct)</span><br><span class="line">print(result_error)</span><br><span class="line">print(result_error2)</span><br></pre></td></tr></table></figure>

<h1 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h1><p><code>创建app</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">manage.py@CRM &gt; startapp rbac</span><br><span class="line">bash -cl <span class="string">"/usr/local/bin/python3.6 /Applications/PyCharm.app/Contents/helpers/pycharm/django_manage.py startapp rbac /Users/cjw/Desktop/CRM"</span></span><br><span class="line">Tracking file by folder pattern:  migrations</span><br><span class="line"></span><br><span class="line">Following files were affected </span><br><span class="line"> /Users/cjw/Desktop/CRM/rbac/migrations/__init__.py</span><br><span class="line">Process finished <span class="keyword">with</span> exit code <span class="number">0</span></span><br><span class="line">manage.py@CRM &gt; startapp web</span><br><span class="line">bash -cl <span class="string">"/usr/local/bin/python3.6 /Applications/PyCharm.app/Contents/helpers/pycharm/django_manage.py startapp web /Users/cjw/Desktop/CRM"</span></span><br><span class="line">Tracking file by folder pattern:  migrations</span><br><span class="line"></span><br><span class="line">Following files were affected </span><br><span class="line"> /Users/cjw/Desktop/CRM/web/migrations/__init__.py</span><br><span class="line">Process finished <span class="keyword">with</span> exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p><code>创建表 在应用rbac中的models创建</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Create your models here.</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Permission</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    权限表</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    title = models.CharField(verbose_name=<span class="string">'标题'</span>, max_length=<span class="number">32</span>)</span><br><span class="line">    url = models.CharField(verbose_name=<span class="string">'含正则的url'</span>, max_length=<span class="number">128</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.title</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Role</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    角色表</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    title = models.CharField(verbose_name=<span class="string">'角色名称'</span>, max_length=<span class="number">32</span>)</span><br><span class="line">    permissions = models.ManyToManyField(verbose_name=<span class="string">'拥有的权限'</span>, to=<span class="string">'Permission'</span>, blank=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.title</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Userinfo</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    用户表</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    name=models.CharField(verbose_name=<span class="string">'用户名'</span>,max_length=<span class="number">32</span>)</span><br><span class="line">    password=models.CharField(verbose_name=<span class="string">'密码'</span>,max_length=<span class="number">64</span>)</span><br><span class="line">    email=models.CharField(verbose_name=<span class="string">'邮箱'</span>,max_length=<span class="number">32</span>)</span><br><span class="line">    roles=models.ManyToManyField(verbose_name=<span class="string">'拥有的所有角色'</span>,to=<span class="string">'Role'</span>,blank=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.name</span><br></pre></td></tr></table></figure>

<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><blockquote>
<p>CRM系统</p>
<ol>
<li>权限</li>
<li>stark组件</li>
<li>CRM业务</li>
</ol>
</blockquote>
<h1 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h1><blockquote>
<ol>
<li><p>创建 Django project， CRM</p>
</li>
<li><p>创建2个app(rbac 权限组件; web 销售管理系统)</p>
</li>
<li><p>app rbac权限组件    将权限相关的表编写到这个app的models.pyzhong</p>
</li>
<li><p>app web  将销售管理系统表写到这里 </p>
</li>
<li><p>两个app的整合</p>
</li>
</ol>
<p>​    销售管理系统中的URL</p>
<p>​    5.1  基于admin进行权限信息的录入</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&gt; url(<span class="string">r'^customer/list/$'</span>, customer.customer_list),</span><br><span class="line">&gt; url(<span class="string">r'^customer/add/$'</span>, customer.customer_add),</span><br><span class="line">&gt; url(<span class="string">r'^customer/edit/(?P&lt;cid&gt;\d+)/$'</span>, customer.customer_edit),</span><br><span class="line">&gt; url(<span class="string">r'^customer/del/(?P&lt;cid&gt;\d+)/$'</span>, customer.customer_del),</span><br><span class="line">&gt; url(<span class="string">r'^customer/import/$'</span>, customer.customer_import),</span><br><span class="line">&gt; url(<span class="string">r'^customer/tpl/$'</span>, customer.customer_tpl),</span><br><span class="line">&gt; </span><br><span class="line">&gt; url(<span class="string">r'^payment/list/$'</span>, payment.payment_list),</span><br><span class="line">&gt; url(<span class="string">r'^payment/add/$'</span>, payment.payment_add),</span><br><span class="line">&gt; url(<span class="string">r'^payment/edit/(?P&lt;pid&gt;\d+)/$'</span>, payment.payment_edit),</span><br><span class="line">&gt; url(<span class="string">r'^payment/del/(?P&lt;pid&gt;\d+)/$'</span>, payment.payment_del),</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>​    5.2   基于admin进行权限和角色信息的分配</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&gt; luowen  	</span><br><span class="line">&gt; 	女教师</span><br><span class="line">&gt; 	客户列表</span><br><span class="line">&gt; 秘书</span><br><span class="line">&gt; 	无</span><br><span class="line">&gt; </span><br><span class="line">&gt; zhouzesb</span><br><span class="line">&gt; 	教导主任</span><br><span class="line">&gt; 	客户列表</span><br><span class="line">&gt;  </span><br><span class="line">&gt; 女教师</span><br><span class="line">&gt; 	客户列表</span><br><span class="line">&gt;  添加客户</span><br><span class="line">&gt;  账单列表</span><br><span class="line">&gt; </span><br><span class="line">&gt; zhangfan</span><br><span class="line">&gt; 	校长</span><br><span class="line">&gt; 	所有权限</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p><a href="**http://oldboy-project.oss-cn-shanghai.aliyuncs.com/CRM/RBAC%E7%BB%84%E4%BB%B6%E5%BC%80%E5%8F%91/luffy_permission%EF%BC%88%E7%A4%BA%E4%BE%8B%E4%B8%89%EF%BC%89%20(1).zip**">源码下载</a></p>
<ol start="6">
<li>快速完成一个基本权限控制</li>
<li>为用户显示自己的菜单</li>
</ol>
</blockquote>
<h2 id="快速完成一个基本权限控制"><a href="#快速完成一个基本权限控制" class="headerlink" title="快速完成一个基本权限控制"></a>快速完成一个基本权限控制</h2><ul>
<li><p>登录页面是否有权限访问</p>
</li>
<li><p>POST请求, 用户登录检验是否合法</p>
</li>
<li><p>获取当前用户相关的所有权限并放入session</p>
</li>
<li><p>再次向服务端发起请求,<a href="http://xxx.xxx.xxx" target="_blank" rel="noopener">http://xxx.xxx.xxx</a>, 后端编写中间件对用户当前访问的URL进行权限的判断(是否在session中)</p>
</li>
</ul>
<h3 id="权限控制的基本流程"><a href="#权限控制的基本流程" class="headerlink" title="权限控制的基本流程"></a>权限控制的基本流程</h3><p><img src="http://hexoblog-image.oss-cn-shanghai.aliyuncs.com/image-20190815230829258.png" alt></p>
<h3 id="用户登录"><a href="#用户登录" class="headerlink" title="用户登录"></a>用户登录</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="number">1.</span> 获取用户信息放入session</span><br><span class="line"><span class="number">2.</span> 获取当前用户所有的权限并写入session</span><br></pre></td></tr></table></figure>

<p><code>urls.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> web.views <span class="keyword">import</span> account</span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r'login'</span>,account.login),</span><br><span class="line">  ....</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p><code>settings.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">PERMISSION_SESSION_KEY=<span class="string">'permission_list'</span></span><br></pre></td></tr></table></figure>

<p><code>/web/views/account.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render, HttpResponse, redirect</span><br><span class="line"><span class="keyword">from</span> rbac <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> luffy_permission <span class="keyword">import</span> settings</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    用户登录</span></span><br><span class="line"><span class="string">    :param request:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'GET'</span>:</span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">'login.html'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># form表单验证</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1, 获取提交的用户名密码</span></span><br><span class="line">    user, pwd = request.POST.get(<span class="string">'user'</span>), request.POST.get(<span class="string">'pwd'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. 检查用户是否合法</span></span><br><span class="line">    obj = models.UserInfo.objects.filter(name=user, password=pwd).first()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> obj:</span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">'login.html'</span>, &#123;<span class="string">'msg'</span>: <span class="string">'用户名或密码错误'</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3. 获取用户信息和权限信息写入session</span></span><br><span class="line">    permissions = obj.roles.filter(permissions__url__isnull=<span class="literal">False</span>).values(<span class="string">'permissions__url'</span>).distinct()</span><br><span class="line">    permissions_list = list(permissions)</span><br><span class="line">    print(permissions_list)</span><br><span class="line">    request.session[<span class="string">'userinfo'</span>] = &#123;<span class="string">'id'</span>: obj.pk, <span class="string">'name'</span>: obj.name&#125;</span><br><span class="line">    request.session[settings.PERMISSION_SESSION_KEY] = permissions_list</span><br><span class="line">    <span class="keyword">return</span> redirect(<span class="string">'/customer/list'</span>)</span><br></pre></td></tr></table></figure>

<h3 id="编写中间件做权限信息校验"><a href="#编写中间件做权限信息校验" class="headerlink" title="编写中间件做权限信息校验"></a>编写中间件做权限信息校验</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="number">1.</span> 获取当前请求URL</span><br><span class="line"><span class="number">2.</span> 获取当前用户的所有权限</span><br><span class="line"><span class="number">3</span> .权限校验</span><br></pre></td></tr></table></figure>

<p><code>settings.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">VALID_URL=[</span><br><span class="line"><span class="string">'^/login/$'</span>,</span><br><span class="line"><span class="string">'^/admin/.*'</span>,</span><br><span class="line">        ]</span><br></pre></td></tr></table></figure>

<p><code>web/middleware/rbac.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django.utils.deprecation <span class="keyword">import</span> MiddlewareMixin</span><br><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</span><br><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> redirect, HttpResponse</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RbacMiddleware</span><span class="params">(MiddlewareMixin)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    权限控制中间件</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_request</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        <span class="string">'''</span></span><br><span class="line"><span class="string">        权限控制</span></span><br><span class="line"><span class="string">        :param request:</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        '''</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 1. 获取当前请求URL</span></span><br><span class="line">        current_url = request.path_info</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 1.5 白名单处理</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> reg <span class="keyword">in</span> settings.VALID_URL:</span><br><span class="line">            <span class="keyword">if</span> re.match(reg,current_url):</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="comment"># 2. 获取当前用户session中所有的权限</span></span><br><span class="line">        permission_list = request.session.get(settings.PERMISSION_SESSION_KEY)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> permission_list:</span><br><span class="line">            <span class="keyword">return</span> redirect(<span class="string">'/login/'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 3. 进行权限校验</span></span><br><span class="line">        print(<span class="string">'current_url'</span>, current_url)</span><br><span class="line">        print(<span class="string">'permission_list'</span>, permission_list)</span><br><span class="line">        flag = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> permission_list:</span><br><span class="line">            reg = <span class="string">'^%s$'</span> % (item.get(<span class="string">'permissions__url'</span>))</span><br><span class="line">            res = re.match(reg, current_url)</span><br><span class="line">            <span class="keyword">if</span> res:</span><br><span class="line">                flag = <span class="literal">True</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> flag:</span><br><span class="line">            <span class="keyword">return</span> HttpResponse(<span class="string">'无权访问'</span>)</span><br></pre></td></tr></table></figure>

<h3 id="小坑"><a href="#小坑" class="headerlink" title="小坑"></a>小坑</h3><ul>
<li>settings.py中的定义的变量必须全部大写, 否则无法调用</li>
<li>不要随便删除cookie, 否则在进入中间件会无法进入视图函数</li>
</ul>
<h2 id="为用户显示自己的菜单"><a href="#为用户显示自己的菜单" class="headerlink" title="为用户显示自己的菜单"></a>为用户显示自己的菜单</h2></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Gorg Chen</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://cjwnb.top/2019/07/31/CRM项目之rcbc/">http://cjwnb.top/2019/07/31/CRM项目之rcbc/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://cjwnb.top">Gorg Chen</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/django/">django    </a><a class="post-meta__tags" href="/tags/CRM/">CRM    </a></div><div class="post_share"><div class="social-share" data-image="http://pic1.win4000.com/pic/1/dc/e2acd32b70.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-buttom"><i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lozad post-qr-code__img" data-src="/img/wechat.jpg"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lozad post-qr-code__img" data-src="/img/alipay.jpg"><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull-left"><a href="/2019/07/31/Stark组件（一）自动生成url/"><img class="prev_cover lozad" data-src="http://pic1.win4000.com/pic/b/c8/e9278727bf.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>Stark组件（一）自动生成url</span></div></a></div><div class="next-post pull-right"><a href="/2019/07/31/面向对象/"><img class="next_cover lozad" data-src="http://pic1.win4000.com/wallpaper/2017-11-08/5a02f4f0e3f12.jpg?down" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>面向对象</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2019/08/05/Django中_Meta 部分用法/" title="Django中_Meta 部分用法"><img class="relatedPosts_cover lozad" data-src="http://pic1.win4000.com/pic/b/c8/e9278727bf.jpg"><div class="relatedPosts_title">Django中_Meta 部分用法</div></a></div><div class="relatedPosts_item"><a href="/2019/08/06/Stark组件（四）列表页面自定义函数扩展/" title="Stark组件（四）列表页面自定义函数扩展"><img class="relatedPosts_cover lozad" data-src="http://pic1.win4000.com/pic/b/c8/e9278727bf.jpg"><div class="relatedPosts_title">Stark组件（四）列表页面自定义函数扩展</div></a></div><div class="relatedPosts_item"><a href="/2019/07/30/CRM项目之必备知识点/" title="CRM项目之必备知识点"><img class="relatedPosts_cover lozad" data-src="http://pic1.win4000.com/pic/1/dc/e2acd32b70.jpg"><div class="relatedPosts_title">CRM项目之必备知识点</div></a></div><div class="relatedPosts_item"><a href="/2019/08/05/Stark组件（二）URL别名的优化/" title="Stark组件（二）URL别名的优化"><img class="relatedPosts_cover lozad" data-src="http://pic1.win4000.com/pic/b/c8/e9278727bf.jpg"><div class="relatedPosts_title">Stark组件（二）URL别名的优化</div></a></div><div class="relatedPosts_item"><a href="/2019/07/31/Stark组件（一）自动生成url/" title="Stark组件（一）自动生成url"><img class="relatedPosts_cover lozad" data-src="http://pic1.win4000.com/pic/b/c8/e9278727bf.jpg"><div class="relatedPosts_title">Stark组件（一）自动生成url</div></a></div><div class="relatedPosts_item"><a href="/2019/08/05/Stark组件（三）定制页面显示的列/" title="Stark组件（三）定制页面显示的列"><img class="relatedPosts_cover lozad" data-src="http://pic1.win4000.com/pic/b/c8/e9278727bf.jpg"><div class="relatedPosts_title">Stark组件（三）定制页面显示的列</div></a></div></div><div class="clear_both"></div></div></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2018 - 2019 By Gorg Chen</div><div class="framework-info"><span>驱动 </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly"><span>Butterfly</span></a></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><section class="rightside" id="rightside"><i class="fa fa-book" id="readmode" title="阅读模式"> </i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换">簡</a><i class="fa fa-moon-o nightshift" id="nightshift" title="夜间模式"></i></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/nightshift.js"></script><script id="ribbon" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/js/piao.js"></script><script src="/js/tw_cn.js"></script><script>translateInitilization()

</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@1.2.2/instantpage.min.js" type="module"></script></body></html>