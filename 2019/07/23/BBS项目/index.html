<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>BBS项目 | Gorg Chen</title><meta name="description" content="BBS项目"><meta name="keywords" content="django,项目"><meta name="author" content="Gorg Chen"><meta name="copyright" content="Gorg Chen"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="canonical" href="http://cjwnb.top/2019/07/23/BBS项目/"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="BBS项目"><meta name="twitter:description" content="BBS项目"><meta name="twitter:image" content="http://pic1.win4000.com/pic/2/59/d366d1f0e7.jpg"><meta property="og:type" content="article"><meta property="og:title" content="BBS项目"><meta property="og:url" content="http://cjwnb.top/2019/07/23/BBS项目/"><meta property="og:site_name" content="Gorg Chen"><meta property="og:description" content="BBS项目"><meta property="og:image" content="http://pic1.win4000.com/pic/2/59/d366d1f0e7.jpg"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="prev" title="CRM项目之必备知识点" href="http://cjwnb.top/2019/07/30/CRM项目之必备知识点/"><link rel="next" title="Django操作session和cookie" href="http://cjwnb.top/2019/07/22/session和cookie/"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":1,"translateDelay":0,"cookieDomain":"https://jerryc.me/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight_copy: 'true',
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: '添加书签',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天'

  
}</script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#项目开发的流程"><span class="toc-number">1.</span> <span class="toc-text">项目开发的流程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#项目需求分析"><span class="toc-number">1.1.</span> <span class="toc-text">项目需求分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#项目架构设计"><span class="toc-number">1.2.</span> <span class="toc-text">项目架构设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#分组开发"><span class="toc-number">1.3.</span> <span class="toc-text">分组开发</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#测试"><span class="toc-number">1.4.</span> <span class="toc-text">测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#交付上线"><span class="toc-number">1.5.</span> <span class="toc-text">交付上线</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#项目需求分析-1"><span class="toc-number">2.</span> <span class="toc-text">项目需求分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#表结构设计"><span class="toc-number">3.</span> <span class="toc-text">表结构设计</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#表与表之间关系判断"><span class="toc-number">3.1.</span> <span class="toc-text">表与表之间关系判断</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#一对一关系"><span class="toc-number">3.2.</span> <span class="toc-text">一对一关系</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#项目需要用到的知识点"><span class="toc-number">4.</span> <span class="toc-text">项目需要用到的知识点</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#img标签的src属性可以接受三种类型的值"><span class="toc-number">4.1.</span> <span class="toc-text">img标签的src属性可以接受三种类型的值</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ORM中的关系字段"><span class="toc-number">4.2.</span> <span class="toc-text">ORM中的关系字段</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Foreign"><span class="toc-number">4.2.1.</span> <span class="toc-text">Foreign</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#to"><span class="toc-number">4.2.1.1.</span> <span class="toc-text">to</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#子关联"><span class="toc-number">4.2.1.1.1.</span> <span class="toc-text">子关联</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#to-field"><span class="toc-number">4.2.1.2.</span> <span class="toc-text">to_field</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#on-delete"><span class="toc-number">4.2.1.3.</span> <span class="toc-text">on_delete</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#models-CASCADE"><span class="toc-number">4.2.1.4.</span> <span class="toc-text">models.CASCADE</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#db-constraint"><span class="toc-number">4.2.1.5.</span> <span class="toc-text">db_constraint</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OneToOneField"><span class="toc-number">4.2.2.</span> <span class="toc-text">OneToOneField</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#to-1"><span class="toc-number">4.2.2.1.</span> <span class="toc-text">to</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#to-field-1"><span class="toc-number">4.2.2.2.</span> <span class="toc-text">to_field</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#on-delete-1"><span class="toc-number">4.2.2.3.</span> <span class="toc-text">on_delete</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ManytoManyField"><span class="toc-number">4.2.3.</span> <span class="toc-text">ManytoManyField</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#through"><span class="toc-number">4.2.4.</span> <span class="toc-text">through</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#through-fields"><span class="toc-number">4.2.5.</span> <span class="toc-text">through_fields</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#生成大小写字母"><span class="toc-number">4.3.</span> <span class="toc-text">生成大小写字母</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#动态生成图片"><span class="toc-number">4.4.</span> <span class="toc-text">动态生成图片</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#图片中插入文字"><span class="toc-number">4.5.</span> <span class="toc-text">图片中插入文字</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#自定义标签"><span class="toc-number">4.6.</span> <span class="toc-text">自定义标签</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#自定义inclusion-tag"><span class="toc-number">4.7.</span> <span class="toc-text">自定义inclusion tag</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DOM操作"><span class="toc-number">4.8.</span> <span class="toc-text">DOM操作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#建表"><span class="toc-number">4.9.</span> <span class="toc-text">建表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Mysql需要设置"><span class="toc-number">4.10.</span> <span class="toc-text">Mysql需要设置</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#功能模块"><span class="toc-number">5.</span> <span class="toc-text">功能模块</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#表设计"><span class="toc-number">5.1.</span> <span class="toc-text">表设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#注册功能"><span class="toc-number">5.2.</span> <span class="toc-text">注册功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#登录功能"><span class="toc-number">5.3.</span> <span class="toc-text">登录功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#后台管理"><span class="toc-number">5.4.</span> <span class="toc-text">后台管理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#media配置"><span class="toc-number">5.5.</span> <span class="toc-text">media配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#个人站点功能"><span class="toc-number">5.6.</span> <span class="toc-text">个人站点功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#后台管理-1"><span class="toc-number">5.7.</span> <span class="toc-text">后台管理</span></a></li></ol></li></ol></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(http://pic1.win4000.com/pic/2/59/d366d1f0e7.jpg)"><div id="page-header"><span class="pull-left"> <a class="blog_title" id="site-name" href="/">Gorg Chen</a></span><div class="open toggle-menu pull-right"><div class="menu-icon-first"></div><div class="menu-icon-second"></div><div class="menu-icon-third"></div></div><span class="pull-right menus"><div class="mobile_author_icon"><img class="lozad" data-src="/img/friend_404.gif" onerror="onerror=null;src='/img/friend_404.gif'"><div class="mobile_author-info__description"></div></div><hr><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a><script>document.body.addEventListener('touchstart', function(){ });</script></div></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title"><div class="posttitle">BBS项目</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2019-07-23<span class="post-meta__separator">|</span><i class="fa fa-history" aria-hidden="true"></i> 更新于 2019-07-30</time><span class="post-meta__separator mobile_hidden">|</span><span class="mobile_hidden"><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/项目/">项目</a></span><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">10k</span><span class="post-meta__separator">|</span><span>阅读时长: 53 分钟</span><span class="post-meta__separator">|</span><span>阅读量: </span><span id="busuanzi_value_page_pv"></span></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><h1 id="项目开发的流程"><a href="#项目开发的流程" class="headerlink" title="项目开发的流程"></a>项目开发的流程</h1><h2 id="项目需求分析"><a href="#项目需求分析" class="headerlink" title="项目需求分析"></a>项目需求分析</h2><p>产品经理+架构师+开发经理/组长 去到客户的公司谈需求(博弈的过程)    </p>
<h2 id="项目架构设计"><a href="#项目架构设计" class="headerlink" title="项目架构设计"></a>项目架构设计</h2><p>架构师设计(数据库(主库:MySQL,从库:redis,mongodb),框架的选择,项目功能划分…) </p>
<blockquote>
<p>报价:每个开发人员1500~3000     300万<br>多部门联合审批    </p>
</blockquote>
<h2 id="分组开发"><a href="#分组开发" class="headerlink" title="分组开发"></a>分组开发</h2><blockquote>
<p>开会 分任务<br>小组人员开始搬砖 (忘生成好的框架内填写代码即可)</p>
</blockquote>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><blockquote>
<ol>
<li>开发人员自己测试（显而易见的bug）</li>
<li>测试人员(妹纸)   </li>
</ol>
</blockquote>
<h2 id="交付上线"><a href="#交付上线" class="headerlink" title="交付上线"></a>交付上线</h2><blockquote>
<ol>
<li>自己的服务器</li>
<li>对方的服务器</li>
</ol>
</blockquote>
<h1 id="项目需求分析-1"><a href="#项目需求分析-1" class="headerlink" title="项目需求分析"></a>项目需求分析</h1><h1 id="表结构设计"><a href="#表结构设计" class="headerlink" title="表结构设计"></a>表结构设计</h1><p>项目最最重要是表结构设计</p>
<blockquote>
<p>如果一张表内的数据分成两块 一块是经常使用的 一块是不经常使用的,这个时候考虑数据优化的问题</p>
</blockquote>
<h2 id="表与表之间关系判断"><a href="#表与表之间关系判断" class="headerlink" title="表与表之间关系判断"></a>表与表之间关系判断</h2><p>表中的一条数据能否对于另外一张表的多条数</p>
<h2 id="一对一关系"><a href="#一对一关系" class="headerlink" title="一对一关系"></a>一对一关系</h2><blockquote>
<ol>
<li>一张表拆成了两张表</li>
<li>两张表中的数据是一一对应的</li>
<li>如果两张表存在一对一关系，比如表a,表b, 则如果其中一张表 表a 与另一张表 表c 存在一对多关系或者多对多关系，那么 表b和表c也是存在同样的关系的</li>
</ol>
</blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">用户表(利用auth_user表)</span><br><span class="line">			phone</span><br><span class="line">			avatar</span><br><span class="line">			create_time</span><br><span class="line">			blog            一对一个人站点</span><br><span class="line">			</span><br><span class="line">				ps:DateField()</span><br><span class="line">					auto_now:每次操作数据都会将当前时间更新</span><br><span class="line">					auto_now_add:自动将创建该数据的时间记录下来之后不再改变</span><br><span class="line">				</span><br><span class="line">		个人站点表</span><br><span class="line">			站点名称 site_name</span><br><span class="line">			站点标题 site_title</span><br><span class="line">			站点样式 site_theme</span><br><span class="line">		</span><br><span class="line">		文章表	</span><br><span class="line">			文章标题 title</span><br><span class="line">			文章简介 desc</span><br><span class="line">			文章内容 content</span><br><span class="line">			发布时间 create_time</span><br><span class="line">			</span><br><span class="line">			blog        	一对多个人站点</span><br><span class="line">			category        一对多分类表</span><br><span class="line">			tag             多对多标签表</span><br><span class="line">			</span><br><span class="line">			<span class="comment"># 数据库设计优化(******)</span></span><br><span class="line">			up_num</span><br><span class="line">			down_num</span><br><span class="line">			comment_num </span><br><span class="line">			<span class="comment"># 当你操作点赞点踩表或者评论表的时候 只要保证上面三个同步更新</span></span><br><span class="line">			</span><br><span class="line">		标签表</span><br><span class="line">			tag_name</span><br><span class="line">			blog          一对多个人站点</span><br><span class="line">		</span><br><span class="line">		分类表</span><br><span class="line">			category_name</span><br><span class="line">			blog  		  一对多个人站点</span><br><span class="line">			</span><br><span class="line">		</span><br><span class="line">		点赞点踩表</span><br><span class="line">			user			一对多user表</span><br><span class="line">			article			一对多article表  </span><br><span class="line">			is_up           <span class="number">0</span>/<span class="number">1</span></span><br><span class="line">		</span><br><span class="line">		文章评论表</span><br><span class="line">			user			一对多user表</span><br><span class="line">			article         一对多article表  </span><br><span class="line">			content         </span><br><span class="line">			create_time</span><br><span class="line">			parent          自关联评论表 (to=<span class="string">'self'</span>)  <span class="comment"># self表示的就是当前表</span></span><br></pre></td></tr></table></figure>

<h1 id="项目需要用到的知识点"><a href="#项目需要用到的知识点" class="headerlink" title="项目需要用到的知识点"></a>项目需要用到的知识点</h1><h2 id="img标签的src属性可以接受三种类型的值"><a href="#img标签的src属性可以接受三种类型的值" class="headerlink" title="img标签的src属性可以接受三种类型的值"></a>img标签的src属性可以接受三种类型的值</h2><blockquote>
<ol>
<li>图片的文件路径</li>
<li>图片的二进制数据</li>
<li>url地址</li>
</ol>
</blockquote>
<h2 id="ORM中的关系字段"><a href="#ORM中的关系字段" class="headerlink" title="ORM中的关系字段"></a>ORM中的关系字段</h2><h3 id="Foreign"><a href="#Foreign" class="headerlink" title="Foreign"></a>Foreign</h3><p>外键类型在ORM中用来表示外键关联关系，一般把ForeignKey字段设置在 ‘一对多’中’多’的一方。</p>
<p>ForeignKey可以和其他表做关联关系同时也可以和自身做关联关系。</p>
<p><code>字段参数</code></p>
<h4 id="to"><a href="#to" class="headerlink" title="to"></a>to</h4><p>设置要关联的表</p>
<h5 id="子关联"><a href="#子关联" class="headerlink" title="子关联"></a>子关联</h5><p>一对多外键的一种</p>
<p>表中的每一行数据有一定的关联性，就需要用到子关联，比如说博客页面的评论下有多个子评论，这种就用到了子关联</p>
<p><img src="https://i.loli.net/2019/07/23/5d36e12e884aa38471.png" alt="parent.png"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Comment</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    评论表</span></span><br><span class="line"><span class="string">    根评论 &gt;&gt;&gt; 一条评论</span></span><br><span class="line"><span class="string">    子评论 &gt;&gt;&gt; 一条评论下的多条评论</span></span><br><span class="line"><span class="string">    所以子评论和多评论是一对多的关系</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    nid = models.AutoField(primary_key=<span class="literal">True</span>)</span><br><span class="line">    article = models.ForeignKey(to=<span class="string">'Article'</span>, to_field=<span class="string">'nid'</span>, verbose_name=<span class="string">'评论文章'</span>) <span class="comment"># 一对多</span></span><br><span class="line">    user = models.ForeignKey(to=<span class="string">'User'</span>, to_field=<span class="string">'nid'</span>, verbose_name=<span class="string">'评论者'</span>)  <span class="comment"># 一对多</span></span><br><span class="line">    content = models.CharField(verbose_name=<span class="string">'评论内容'</span>, max_length=<span class="number">255</span>)</span><br><span class="line">    create_time = models.DateTimeField(verbose_name=<span class="string">'创建时间'</span>, auto_now_add=<span class="literal">True</span>)</span><br><span class="line">    parent_comment = models.ForeignKey(to=<span class="string">'self'</span>, null=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.content</span><br></pre></td></tr></table></figure>

<h4 id="to-field"><a href="#to-field" class="headerlink" title="to_field"></a>to_field</h4><p>设置要关联的表的字段</p>
<h4 id="on-delete"><a href="#on-delete" class="headerlink" title="on_delete"></a><strong>on_delete</strong></h4><p>当删除关联表中的数据时，当前表与其关联的行的行为。</p>
<h4 id="models-CASCADE"><a href="#models-CASCADE" class="headerlink" title="models.CASCADE"></a><strong>models.CASCADE</strong></h4><p>删除关联数据，与之关联也删除</p>
<h4 id="db-constraint"><a href="#db-constraint" class="headerlink" title="db_constraint"></a>db_constraint</h4><p>是否在数据库中创建外键约束，默认为True。</p>
<p><code>其余字段参数</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">models.DO_NOTHING</span><br><span class="line">删除关联数据，引发错误IntegrityError</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">models.PROTECT</span><br><span class="line">删除关联数据，引发错误ProtectedError</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">models.SET_NULL</span><br><span class="line">删除关联数据，与之关联的值设置为null（前提FK字段需要设置为可空）</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">models.SET_DEFAULT</span><br><span class="line">删除关联数据，与之关联的值设置为默认值（前提FK字段需要设置默认值）</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">models.SET</span><br><span class="line"></span><br><span class="line">删除关联数据，</span><br><span class="line">a. 与之关联的值设置为指定值，设置：models.SET(值)</span><br><span class="line">b. 与之关联的值设置为可执行对象的返回值，设置：models.SET(可执行对象)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyModel</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    user = models.ForeignKey(</span><br><span class="line">        to=<span class="string">"User"</span>,</span><br><span class="line">        to_field=<span class="string">"id"</span>，</span><br><span class="line">        on_delete=models.SET(func)</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>

<h3 id="OneToOneField"><a href="#OneToOneField" class="headerlink" title="OneToOneField"></a>OneToOneField</h3><p>一对一字段。</p>
<p>通常一对一字段用来扩展已有字段。(通俗的说就是一个人的所有信息不是放在一张表里面的，简单的信息一张表，隐私的信息另一张表，之间通过一对一外键关联)</p>
<p><code>字段参数</code></p>
<h4 id="to-1"><a href="#to-1" class="headerlink" title="to"></a>to</h4><p>设置要关联的表。</p>
<h4 id="to-field-1"><a href="#to-field-1" class="headerlink" title="to_field"></a>to_field</h4><p>设置要关联的字段。</p>
<h4 id="on-delete-1"><a href="#on-delete-1" class="headerlink" title="on_delete"></a>on_delete</h4><p>当删除关联表中的数据时，当前表与其关联的行的行为。(参考上面的例子)</p>
<h3 id="ManytoManyField"><a href="#ManytoManyField" class="headerlink" title="ManytoManyField"></a>ManytoManyField</h3><p>“关联管理器”是在一对多或者多对多的关联上下文中使用的管理器。</p>
<p>它存在于下面两种情况：</p>
<ol>
<li>外键关系的反向查询</li>
<li>多对多关联关系</li>
</ol>
<p>简单来说就是在多对多表关系并且这一张多对多的关系表是有Django自动帮你建的情况下，下面的方法才可使用。</p>
<h3 id="through"><a href="#through" class="headerlink" title="through"></a>through</h3><p>放存储表关系的那张表的名字</p>
<h3 id="through-fields"><a href="#through-fields" class="headerlink" title="through_fields"></a>through_fields</h3><p>through_fields=（’参数1‘，’参数2‘）</p>
<p>参数1： 放存表多对多的表关系的那张表要查到当前的这张表需要通过哪个字段可以查得到</p>
<p>参数2： 放存表多对多的表关系的那张表的另一个关联字段的名字</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tag</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    标签表</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    nid = models.AutoField(primary_key=<span class="literal">True</span>)</span><br><span class="line">    title = models.CharField(verbose_name=<span class="string">'标签名称'</span>, max_length=<span class="number">32</span>)</span><br><span class="line">    blog = models.ForeignKey(verbose_name=<span class="string">'所属博客'</span>, to=<span class="string">'Blog'</span>, to_field=<span class="string">'nid'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.title</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Article</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    nid = models.AutoField(primary_key=<span class="literal">True</span>)</span><br><span class="line">    title = models.CharField(max_length=<span class="number">50</span>, verbose_name=<span class="string">'文章标题'</span>)</span><br><span class="line">    desc = models.CharField(max_length=<span class="number">255</span>, verbose_name=<span class="string">'文章描述'</span>)</span><br><span class="line">    create_time = models.DateTimeField(verbose_name=<span class="string">'创建时间'</span>, auto_now_add=<span class="literal">True</span>)</span><br><span class="line">    content = models.TextField()</span><br><span class="line"></span><br><span class="line">    tag = models.ManyToManyField(to=<span class="string">'Tag'</span>, through=<span class="string">'Article2tag'</span>, through_fields=(<span class="string">'article'</span>, <span class="string">'tag'</span>))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.title</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Article2tag</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    nid = models.AutoField(primary_key=<span class="literal">True</span>)</span><br><span class="line">    article = models.ForeignKey(verbose_name=<span class="string">'文章'</span>, to=<span class="string">'Article'</span>, to_field=<span class="string">'nid'</span>)</span><br><span class="line">    tag = models.ForeignKey(verbose_name=<span class="string">'标签'</span>, to=<span class="string">'Tag'</span>, to_field=<span class="string">'nid'</span>)</span><br></pre></td></tr></table></figure>

<h2 id="生成大小写字母"><a href="#生成大小写字母" class="headerlink" title="生成大小写字母"></a>生成大小写字母</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>chr(<span class="number">65</span>)</span><br><span class="line"><span class="string">'A</span></span><br><span class="line"><span class="string">&gt;&gt;&gt; chr(90)</span></span><br><span class="line"><span class="string">'</span>Z<span class="string">'</span></span><br><span class="line"><span class="string">&gt;&gt;&gt; chr(97)</span></span><br><span class="line"><span class="string">'</span>a<span class="string">'</span></span><br><span class="line"><span class="string">&gt;&gt;&gt; chr(122)</span></span><br><span class="line"><span class="string">'</span>z<span class="string">'</span></span><br></pre></td></tr></table></figure>

<h2 id="动态生成图片"><a href="#动态生成图片" class="headerlink" title="动态生成图片"></a>动态生成图片</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> HttpResponse</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_valid_img</span><span class="params">(request)</span>:</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">get_random_color</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">import</span> random</span><br><span class="line">    <span class="keyword">return</span> (random.randint(<span class="number">0</span>, <span class="number">255</span>), random.randint(<span class="number">0</span>, <span class="number">255</span>), random.randint(<span class="number">0</span>, <span class="number">255</span>))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">from</span> PIL <span class="keyword">import</span> Image, ImageDraw, ImageFont</span><br><span class="line">  <span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line">  img = Image.new(<span class="string">'RGB'</span>, (<span class="number">270</span>, <span class="number">35</span>), color=get_random_color())</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 通过磁盘处理</span></span><br><span class="line">  <span class="keyword">with</span> open(<span class="string">"validCode.png"</span>, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    img.save(f,<span class="string">'png'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">"validCode.png"</span>, <span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">      data = f.read()</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 通过内存处理</span></span><br><span class="line">  <span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line">  f = BytesIO()</span><br><span class="line">  img.save(f, <span class="string">'png'</span>)</span><br><span class="line">  data = f.getvalue()</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> HttpResponse(data)</span><br></pre></td></tr></table></figure>

<h2 id="图片中插入文字"><a href="#图片中插入文字" class="headerlink" title="图片中插入文字"></a>图片中插入文字</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> ImageDraw,Image,ImageFont</span><br><span class="line"></span><br><span class="line">image=Image.open(<span class="string">'background.jpg'</span>)</span><br><span class="line">drawobj=ImageDraw.Draw(image)</span><br><span class="line">text=<span class="string">'Hello World'</span></span><br><span class="line">font=ImageFont.truetype(<span class="string">'static/font/大梁体繁简精全2016版(9月版).ttf'</span>,<span class="number">40</span>)</span><br><span class="line">drawobj.text([<span class="number">300</span>,<span class="number">500</span>],text,font=font)</span><br><span class="line">image.show()</span><br></pre></td></tr></table></figure>

<h2 id="自定义标签"><a href="#自定义标签" class="headerlink" title="自定义标签"></a>自定义标签</h2><p><code>app01/templatetags/mytags</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> template</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">register=template.Library()</span><br><span class="line"></span><br><span class="line"><span class="meta">@register.simple_tag()</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">multify</span><span class="params">(x,y)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> x*y</span><br></pre></td></tr></table></figure>

<p><code>使用</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;% load mytags %&#125;</span><br><span class="line"> &#123;% multify <span class="number">23</span> <span class="number">9</span> %&#125;</span><br></pre></td></tr></table></figure>

<h2 id="自定义inclusion-tag"><a href="#自定义inclusion-tag" class="headerlink" title="自定义inclusion tag"></a>自定义inclusion tag</h2><p>本质上就是自定义标签，只是功能通过一个html文件进行传递</p>
<p><code>app01/templatetags/mytags</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@register.inclusion_tag('classification.html')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_classification_style</span><span class="params">(username)</span>:</span></span><br><span class="line">    blog = models.Blog.objects.filter(site_name=username).first()</span><br><span class="line">    article_list = models.Article.objects.filter(blog=blog)</span><br><span class="line">    category_list = models.Category.objects.filter(blog=blog).annotate(c=Count(<span class="string">'article'</span>)).values_list(<span class="string">'title'</span>, <span class="string">'c'</span>,</span><br><span class="line">                                                                                                       <span class="string">'nid'</span>)</span><br><span class="line">    tag_list = models.Tag.objects.filter(blog=blog).annotate(c=Count(<span class="string">'article'</span>)).values_list(<span class="string">'title'</span>, <span class="string">'c'</span>, <span class="string">'nid'</span>)</span><br><span class="line">    month_list = models.Article.objects.filter(blog=blog).annotate(month=TruncMonth(<span class="string">'create_time'</span>)).values(</span><br><span class="line">        <span class="string">'month'</span>).annotate(c=Count(<span class="string">'pk'</span>)).values_list(<span class="string">'month'</span>, <span class="string">'c'</span>)</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">'blog'</span>: blog, <span class="string">'article_list'</span>: article_list, <span class="string">'category_list'</span>: category_list, <span class="string">'tag_list'</span>: tag_list,<span class="string">'month_list'</span>:month_list&#125;</span><br></pre></td></tr></table></figure>

<p><code>classification.html</code></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;div&gt;</span><br><span class="line">    &lt;div class="panel panel-success"&gt;</span><br><span class="line">        &lt;div class="panel-heading"&gt;</span><br><span class="line">            &lt;h3 class="panel-title"&gt;文章分类&lt;/h3&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div class="panel-body"&gt;</span><br><span class="line">            &#123;% <span class="keyword">for</span> category <span class="keyword">in</span> category_list %&#125;</span><br><span class="line">                &lt;p&gt;&lt;a href="/&#123;&#123; username &#125;&#125;/category/&#123;&#123; category.2 &#125;&#125;"&gt;&#123;&#123; category.0 &#125;&#125;&lt;/a&gt;&amp;nbsp;(&#123;&#123; category.1 &#125;&#125;)&lt;/p&gt;</span><br><span class="line">            &#123;% endfor %&#125;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;div class="panel panel-danger"&gt;</span><br><span class="line">        &lt;div class="panel-heading"&gt;</span><br><span class="line">            &lt;h3 class="panel-title"&gt;文章标签&lt;/h3&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div class="panel-body"&gt;</span><br><span class="line">            &#123;% <span class="keyword">for</span> tag <span class="keyword">in</span> tag_list %&#125;</span><br><span class="line">                &lt;p&gt;&lt;a href="/&#123;&#123; username &#125;&#125;/tag/&#123;&#123; tag.2 &#125;&#125;"&gt;&#123;&#123; tag.0 &#125;&#125;&lt;/a&gt;&amp;nbsp;(&#123;&#123; tag.1 &#125;&#125;)&lt;/p&gt;</span><br><span class="line">            &#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;div class="panel panel-info"&gt;</span><br><span class="line">        &lt;div class="panel-heading"&gt;</span><br><span class="line">            &lt;h3 class="panel-title"&gt;日期归档 &lt;/h3&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div class="panel-body"&gt;</span><br><span class="line">            &#123;% <span class="keyword">for</span> month <span class="keyword">in</span> month_list %&#125;</span><br><span class="line">                &lt;p&gt;</span><br><span class="line">                    &lt;a href="/&#123;&#123; username &#125;&#125;/archive/&#123;&#123; month.0|date:'Y/m' &#125;&#125;"&gt;&#123;&#123; month.0 |date:'Y年m月' &#125;&#125;&lt;/a&gt;&amp;nbsp;(&#123;&#123; month.1 &#125;&#125;)</span><br><span class="line">                &lt;/p&gt;</span><br><span class="line">            &#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<p><code>使用</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;% load mytags %&#125;</span><br><span class="line">&#123;% get_classification_style username  %&#125;</span><br></pre></td></tr></table></figure>

<h2 id="DOM操作"><a href="#DOM操作" class="headerlink" title="DOM操作"></a>DOM操作</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">var name=<span class="string">'lyysb'</span></span><br><span class="line">var age=<span class="number">38</span></span><br><span class="line">console.log(`Her name <span class="keyword">is</span> $&#123;name&#125;, <span class="keyword">and</span> its age <span class="keyword">is</span> $&#123;age&#125;`)</span><br></pre></td></tr></table></figure>

<h2 id="建表"><a href="#建表" class="headerlink" title="建表"></a>建表</h2><p><code>settings.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Mysql需要设置"><a href="#Mysql需要设置" class="headerlink" title="Mysql需要设置"></a>Mysql需要设置</h2><p> NO_ENGINE_SUBSTITUTION  模式，否则有时候进行反向查询会报错</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">mysql&gt; show variables like <span class="string">"sql_mode"</span></span><br><span class="line">    -&gt; ;</span><br><span class="line">+---------------+------------------------+</span><br><span class="line">| Variable_name | Value                  |</span><br><span class="line">+---------------+------------------------+</span><br><span class="line">| sql_mode      | NO_ENGINE_SUBSTITUTION |</span><br><span class="line">+---------------+------------------------+</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> set (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; set <span class="keyword">global</span> sql_mode=NO_ENGINE_SUBSTITUTION;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>

<h1 id="功能模块"><a href="#功能模块" class="headerlink" title="功能模块"></a>功能模块</h1><h2 id="表设计"><a href="#表设计" class="headerlink" title="表设计"></a>表设计</h2><p><code>settings.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">DATABASES = &#123;</span><br><span class="line">    <span class="string">'default'</span>: &#123;</span><br><span class="line">        <span class="string">'ENGINE'</span>: <span class="string">'django.db.backends.mysql'</span>,</span><br><span class="line">        <span class="string">'NAME'</span>: <span class="string">'bbs4'</span>,</span><br><span class="line">        <span class="string">'USER'</span>: <span class="string">'root'</span>,</span><br><span class="line">        <span class="string">'PASSWORD'</span>: <span class="string">'123'</span>,</span><br><span class="line">        <span class="string">'HOST'</span>: <span class="string">'127.0.0.1'</span>,</span><br><span class="line">        <span class="string">'PORT'</span>: <span class="number">3306</span>,</span><br><span class="line">        <span class="string">'CHARSET'</span>: <span class="string">'utf8'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">AUTH_USER_MODEL=<span class="string">'blog.Userinfo'</span>  </span><br><span class="line"><span class="comment"># 一定要加这句话，因为Userinfo是继承auth组件的那个表，所以需要配置，否则在床架表的时候会出现如下报错</span></span><br><span class="line"></span><br><span class="line">（SystemCheckError: System check identified some issues:</span><br><span class="line"></span><br><span class="line">ERRORS:</span><br><span class="line">auth.User.groups: (fields.E304) Reverse accessor <span class="keyword">for</span> <span class="string">'User.groups'</span> clashes <span class="keyword">with</span> reverse accessor <span class="keyword">for</span> <span class="string">'Userinfo.groups'</span>.</span><br><span class="line">	HINT: Add <span class="keyword">or</span> change a related_name argument to the definition <span class="keyword">for</span> <span class="string">'User.groups'</span> <span class="keyword">or</span> <span class="string">'Userinfo.groups'</span>.</span><br><span class="line">auth.User.user_permissions: (fields.E304) Reverse accessor <span class="keyword">for</span> <span class="string">'User.user_permissions'</span> clashes <span class="keyword">with</span> reverse accessor <span class="keyword">for</span> <span class="string">'Userinfo.user_permissions'</span>.</span><br><span class="line">	HINT: Add <span class="keyword">or</span> change a related_name argument to the definition <span class="keyword">for</span> <span class="string">'User.user_permissions'</span> <span class="keyword">or</span> <span class="string">'Userinfo.user_permissions'</span>.</span><br><span class="line">blog.Userinfo.groups: (fields.E304) Reverse accessor <span class="keyword">for</span> <span class="string">'Userinfo.groups'</span> clashes <span class="keyword">with</span> reverse accessor <span class="keyword">for</span> <span class="string">'User.groups'</span>.</span><br><span class="line">	HINT: Add <span class="keyword">or</span> change a related_name argument to the definition <span class="keyword">for</span> <span class="string">'Userinfo.groups'</span> <span class="keyword">or</span> <span class="string">'User.groups'</span>.</span><br><span class="line">blog.Userinfo.user_permissions: (fields.E304) Reverse accessor <span class="keyword">for</span> <span class="string">'Userinfo.user_permissions'</span> clashes <span class="keyword">with</span> reverse accessor <span class="keyword">for</span> <span class="string">'User.user_permissions'</span>.</span><br><span class="line">	HINT: Add <span class="keyword">or</span> change a related_name argument to the definition <span class="keyword">for</span> <span class="string">'Userinfo.user_permissions'</span> <span class="keyword">or</span> <span class="string">'User.user_permissions'</span>.）</span><br></pre></td></tr></table></figure>

<p><code>__init__.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line">pymysql.install_as_MySQLdb()</span><br></pre></td></tr></table></figure>

<p><code>快捷键alt+R执行manager.py脚本</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">manage.py@bbs3 &gt; makemigrations</span><br><span class="line">manage.py@bbs3 &gt; migrate</span><br></pre></td></tr></table></figure>

<h2 id="注册功能"><a href="#注册功能" class="headerlink" title="注册功能"></a>注册功能</h2><p><code>静态文件配置 settings.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">STATIC_URL = <span class="string">'/static/'</span></span><br><span class="line">STATICFILES_DIRS = [</span><br><span class="line">    os.path.join(BASE_DIR, <span class="string">'static'</span>)</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<blockquote>
<p>前端获取用户输入，前端和后端需要对用户输入的信息进行校验（form）</p>
</blockquote>
<p><code>form组件校验数据</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> forms</span><br><span class="line"><span class="keyword">from</span> django.forms <span class="keyword">import</span> widgets</span><br><span class="line"><span class="keyword">from</span> blog <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> django.core.exceptions <span class="keyword">import</span> ValidationError</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyForm</span><span class="params">(forms.Form)</span>:</span></span><br><span class="line">    username = forms.CharField(max_length=<span class="number">8</span>,</span><br><span class="line">                               min_length=<span class="number">3</span>,</span><br><span class="line">                               label=<span class="string">'用户名'</span>,</span><br><span class="line">                               error_messages=&#123;</span><br><span class="line">                                   <span class="string">'max_length'</span>: <span class="string">'用户名最长8位'</span>,</span><br><span class="line">                                   <span class="string">'min_length'</span>: <span class="string">'用户名最短3位'</span>,</span><br><span class="line">                                   <span class="string">'required'</span>: <span class="string">'用户名不能为空'</span></span><br><span class="line">                               &#125;,</span><br><span class="line">                               widget=widgets.TextInput(</span><br><span class="line">                                   attrs=&#123;<span class="string">'class'</span>: <span class="string">'form-control'</span>&#125;))</span><br><span class="line">    password = forms.CharField(max_length=<span class="number">8</span>,</span><br><span class="line">                               min_length=<span class="number">3</span>,</span><br><span class="line">                               label=<span class="string">'密码'</span>,</span><br><span class="line">                               error_messages=&#123;</span><br><span class="line">                                   <span class="string">'max_length'</span>: <span class="string">'密码最长8位'</span>,</span><br><span class="line">                                   <span class="string">'min_length'</span>: <span class="string">'密码最短3位'</span>,</span><br><span class="line">                                   <span class="string">'required'</span>: <span class="string">'密码不能为空'</span></span><br><span class="line">                               &#125;,</span><br><span class="line">                               widget=widgets.TextInput(</span><br><span class="line">                                   attrs=&#123;<span class="string">'class'</span>: <span class="string">'form-control'</span>&#125;))</span><br><span class="line">    confirm_password = forms.CharField(max_length=<span class="number">8</span>,</span><br><span class="line">                                       min_length=<span class="number">3</span>,</span><br><span class="line">                                       label=<span class="string">'确认密码'</span>,</span><br><span class="line">                                       error_messages=&#123;</span><br><span class="line">                                           <span class="string">'max_length'</span>: <span class="string">'确认密码最长8位'</span>,</span><br><span class="line">                                           <span class="string">'min_length'</span>: <span class="string">'确认密码最短3位'</span>,</span><br><span class="line">                                           <span class="string">'required'</span>: <span class="string">'确认密码不能为空'</span></span><br><span class="line">                                       &#125;,</span><br><span class="line">                                       widget=widgets.TextInput(</span><br><span class="line">                                           attrs=&#123;<span class="string">'class'</span>: <span class="string">'form-control'</span>&#125;))</span><br><span class="line">    email = forms.EmailField(label=<span class="string">'邮箱'</span>, error_messages=&#123;</span><br><span class="line">                                              <span class="string">'invalid'</span>: <span class="string">'邮箱格式错误'</span>,</span><br><span class="line">                                              <span class="string">'required'</span>: <span class="string">'邮箱不能为空'</span></span><br><span class="line">                                          &#125;,</span><br><span class="line">                                       widget=widgets.EmailInput(</span><br><span class="line">                                           attrs=&#123;<span class="string">'class'</span>: <span class="string">'form-control'</span>&#125;))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 局部钩子 判断当前用户名是否存在</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean_username</span><span class="params">(self)</span>:</span></span><br><span class="line">        username = self.cleaned_data[<span class="string">'username'</span>]</span><br><span class="line">        user_obj = models.Userinfo.objects.filter(username=username).first()</span><br><span class="line">        <span class="keyword">if</span> user_obj:</span><br><span class="line">            <span class="keyword">raise</span> ValidationError(<span class="string">'用户名已存在'</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> username</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 全局钩子，校验两次密码是否一致</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean</span><span class="params">(self)</span>:</span></span><br><span class="line">        password = self.cleaned_data.get(<span class="string">'password'</span>)</span><br><span class="line">        confirm_password = self.cleaned_data.get(<span class="string">'confirm_password'</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> password == confirm_password:</span><br><span class="line">            self.add_error(<span class="string">'confirm_password'</span>, <span class="string">'两次密码输入不一致'</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> self.cleaned_data</span><br></pre></td></tr></table></figure>

<blockquote>
<p>写注册页面  </p>
<p>前端： 页面布局，设计点击事件（click）和修改事件(change)</p>
<p>后端： 对校验的数据进行处理，操作数据库</p>
</blockquote>
<p><code>后端业务逻辑</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render,HttpResponse,redirect</span><br><span class="line"><span class="keyword">from</span> django.views <span class="keyword">import</span> View</span><br><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url</span><br><span class="line"><span class="keyword">from</span> blog <span class="keyword">import</span> views</span><br><span class="line">urlpatterns = [</span><br><span class="line"><span class="comment"># 注册功能</span></span><br><span class="line">    url(<span class="string">r'^register/'</span>, views.Register.as_view()),</span><br><span class="line">    url(<span class="string">r'^login/'</span>, views.Login.as_view()),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render, HttpResponse, redirect</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create your views here.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.views <span class="keyword">import</span> View</span><br><span class="line"><span class="keyword">from</span> blog <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> blog <span class="keyword">import</span> myforms</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> JsonResponse</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Register</span><span class="params">(View)</span>:</span></span><br><span class="line">    form = myforms.MyForm()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">'register.html'</span>, &#123;<span class="string">'form'</span>: self.form&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        <span class="comment"># 前端提交后进行校验，提交就是post请求</span></span><br><span class="line">        <span class="comment"># &#123;'csrfmiddlewaretoken': 								['FELJgdjWNKdUXizMQ2GAqF6QMtZxYHvquEXJodcjrL8GRaVBknZ8VINjud6bX52X'],</span></span><br><span class="line">        <span class="comment">#  'username': ['lxx'],</span></span><br><span class="line">        <span class="comment">#  'password': ['123'],</span></span><br><span class="line">        <span class="comment">#  'confirm_password': ['123'],</span></span><br><span class="line">        <span class="comment">#  'email': ['123@qq.com']&#125;</span></span><br><span class="line">        response = &#123;<span class="string">'status'</span>: <span class="literal">False</span>, <span class="string">'msg'</span>: <span class="literal">None</span>&#125;</span><br><span class="line">        form = myforms.MyForm(request.POST)</span><br><span class="line">        print(form.is_valid())</span><br><span class="line">        print(form.cleaned_data)</span><br><span class="line">        <span class="keyword">if</span> form.is_valid():</span><br><span class="line">            <span class="comment"># 校验通过，数据库查数据</span></span><br><span class="line">            response[<span class="string">'status'</span>] = <span class="literal">True</span></span><br><span class="line">            response[<span class="string">'msg'</span>] = <span class="string">'注册成功'</span></span><br><span class="line">            <span class="comment"># &#123;'username': 'lxx', 'password': '123', 'confirm_password': '123', 'email': '123@qq.com'&#125;</span></span><br><span class="line">            clean_data = form.cleaned_data</span><br><span class="line">            clean_data.pop(<span class="string">'confirm_password'</span>)  <span class="comment"># &#123;'username': 'lxx', 'password': '123', 'email': '123@qq.com'&#125;</span></span><br><span class="line">            <span class="keyword">if</span> request.FILES:</span><br><span class="line">                <span class="comment"># &lt; MultiValueDict: &#123;'file_obj': [ &lt; InMemoryUploadedFile: timg.jpeg(image / jpeg) &gt;]&#125; &gt;</span></span><br><span class="line">                clean_data[<span class="string">'avatar'</span>] = request.FILES.get(<span class="string">'file_obj'</span>)</span><br><span class="line">            <span class="comment"># 前面数据准备成功了，写入数据库</span></span><br><span class="line">            <span class="comment"># &#123;'username': 'lxx', 'password': '123', 'email': '123@qq.com', 'avatar': &lt; InMemoryUploadedFile: timg.jpeg(image / jpeg) &gt;&#125;</span></span><br><span class="line">            models.Userinfo.objects.create_user(**clean_data)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 校验不通过，返回错误信息</span></span><br><span class="line">            response[<span class="string">'msg'</span>] = form.errors</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> JsonResponse(response, json_dumps_params=&#123;<span class="string">'ensure_ascii'</span>: <span class="literal">False</span>&#125;)</span><br></pre></td></tr></table></figure>

<p><code>前端业务逻辑</code></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">"en"</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">"UTF-8"</span>&gt;</span><br><span class="line">    &lt;meta name=<span class="string">"viewport"</span> content=<span class="string">"width=device-width, initial-scale=1"</span>&gt;</span><br><span class="line">    &lt;title&gt;注册&lt;/title&gt;</span><br><span class="line">    &lt;script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.js"&gt;&lt;/script&gt;</span><br><span class="line">    &lt;link rel=<span class="string">"stylesheet"</span> href=<span class="string">"/static/blog/bs/css/bootstrap.css"</span>&gt;</span><br><span class="line">    &lt;script src="/static/blog/bs/js/bootstrap.js"&gt;&lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h2 class="text-primary text-center panel-body"&gt;注册页面&lt;/h2&gt;</span><br><span class="line">&lt;div class="container" style="margin-top: 26px"&gt;</span><br><span class="line">    &lt;div class="row"&gt;</span><br><span class="line">        &lt;div class="col-md-6 col-md-offset-3"&gt;</span><br><span class="line">            &lt;form id=<span class="string">"form"</span>&gt;</span><br><span class="line">                &#123;% csrf_token %&#125;</span><br><span class="line">                &#123;% <span class="keyword">for</span> foo <span class="keyword">in</span> form %&#125;</span><br><span class="line">                    &lt;div class="form form-group"&gt;</span><br><span class="line">                        &lt;label for="&#123;&#123; foo.auto_id &#125;&#125;"&gt;&#123;&#123; foo.label &#125;&#125;&lt;/label&gt;</span><br><span class="line">                        &#123;&#123; foo &#125;&#125; &lt;span class="pull-right error"&gt;&lt;/span&gt;</span><br><span class="line">                    &lt;/div&gt;</span><br><span class="line">                &#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line">                &lt;div class="form-group"&gt;</span><br><span class="line">                    &lt;label <span class="keyword">for</span>=<span class="string">"avatar"</span>&gt;头像</span><br><span class="line">                        &lt;img src=<span class="string">"/static/blog/images/default.jpg"</span> id=<span class="string">"avatar_img"</span> alt=<span class="string">""</span> width=<span class="string">"50px"</span>&gt;</span><br><span class="line">                    &lt;/label&gt;</span><br><span class="line">                    &lt;input type="file" id="avatar" class="hidden"&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">            &lt;/form&gt;</span><br><span class="line">            &lt;input type="button" class="btn btn-primary btn-group-justified reg_btn" value="注册"&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    $(<span class="string">'.reg_btn'</span>).click(function () &#123;</span><br><span class="line">        //console.log($(<span class="string">'#form'</span>).serializeArray().val());</span><br><span class="line">        var formdata = new FormData();</span><br><span class="line">        var request_data = $(<span class="string">'#form'</span>).serializeArray();</span><br><span class="line"></span><br><span class="line">        $.each(request_data, function (index, data) &#123;</span><br><span class="line">            formdata.append(data.name, data.value);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        //$.each(request_data, function (index, data) &#123;</span><br><span class="line"></span><br><span class="line">        //  formdata.append(data.name, data.value)</span><br><span class="line">        //&#125;);</span><br><span class="line"></span><br><span class="line">        // 加入图片对象</span><br><span class="line">        formdata.append(<span class="string">'file_obj'</span>, $(<span class="string">'#avatar'</span>)[<span class="number">0</span>].files[<span class="number">0</span>]);</span><br><span class="line">        //File &#123;name: <span class="string">"1P512151355-2.jpg"</span>,</span><br><span class="line">        // lastModified: <span class="number">1564212672633</span>,</span><br><span class="line">        // lastModifiedDate: Sat Jul <span class="number">27</span> <span class="number">2019</span> <span class="number">15</span>:<span class="number">31</span>:<span class="number">12</span> GMT+<span class="number">0800</span> (中国标准时间),</span><br><span class="line">        // webkitRelativePath: <span class="string">""</span>, size: <span class="number">365545</span>, …&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        $.ajax(&#123;</span><br><span class="line">            url: <span class="string">''</span>,</span><br><span class="line">            type: <span class="string">'post'</span>,</span><br><span class="line">            data: formdata,</span><br><span class="line">            contentType: false,</span><br><span class="line">            processData: false,</span><br><span class="line">            success: function (data) &#123;</span><br><span class="line">                console.log(data.status);</span><br><span class="line">                <span class="keyword">if</span> (data.status) &#123;</span><br><span class="line">                    //跳转到登录界面</span><br><span class="line">                    location.href = <span class="string">'/login/'</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    //如果注册不能够，在按钮旁边显示报错信息</span><br><span class="line"></span><br><span class="line">                    // $(<span class="string">'.error'</span>).html(data.msg);</span><br><span class="line">                    $.each(data.msg, function (index, error_list) &#123;</span><br><span class="line">                        // 根据form表单自动生成id的规律拼出id，并在其下一个标签添加错误信息</span><br><span class="line">                        tag_id = <span class="string">'#id_'</span> + index;</span><br><span class="line">                        $(tag_id).next().html(error_list[<span class="number">0</span>]).css(&#123;<span class="string">'color'</span>:<span class="string">'red'</span>&#125;).parent().addClass(<span class="string">'has-error'</span>)</span><br><span class="line">                    &#125;);</span><br><span class="line"></span><br><span class="line">                    $(<span class="string">'input'</span>).focus(function () &#123;</span><br><span class="line">                        $(this).next().text(<span class="string">''</span>).parent().removeClass(<span class="string">'has-error'</span>)</span><br><span class="line">                    &#125;)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">     // 使得图片能够在前台显示缩略图</span><br><span class="line">     //获取文件对象的路径</span><br><span class="line">    $(<span class="string">'#avatar'</span>).change(function () &#123;</span><br><span class="line">        //获取用户选中的文件对象</span><br><span class="line">        var file_obj=$(this)[<span class="number">0</span>].files[<span class="number">0</span>];</span><br><span class="line">        //使用文件阅读器读取文件</span><br><span class="line">        var reader=new FileReader(); // 定义阅读器</span><br><span class="line">        reader.readAsDataURL(file_obj) //读取文件对象的路径</span><br><span class="line">        //reader.result  最后的结果保存在result方法中</span><br><span class="line">        //修改img的src属性</span><br><span class="line">        // reader.onload表示当执行完reader的代码再执行onload方法中定义的代码</span><br><span class="line">        reader.onload=function () &#123;</span><br><span class="line">            $(<span class="string">'#avatar_img'</span>).attr(<span class="string">"src"</span>,reader.result)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<h2 id="登录功能"><a href="#登录功能" class="headerlink" title="登录功能"></a>登录功能</h2><p><code>后端业务逻辑</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url</span><br><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> blog <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r'^admin/'</span>, admin.site.urls),</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 注册功能</span></span><br><span class="line">    url(<span class="string">r'^register/'</span>, views.Register.as_view()),</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 登录功能</span></span><br><span class="line">    url(<span class="string">r'^login/'</span>, views.Login.as_view()),</span><br><span class="line">    url(<span class="string">r'^get_valid_img/'</span>, views.Login.get_valid_img),</span><br><span class="line">    url(<span class="string">r'^logout/'</span>, views.Login.logout),</span><br><span class="line">    url(<span class="string">r'^set_password/'</span>, views.Login.set_password),</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 主页</span></span><br><span class="line">    url(<span class="string">r'^index/'</span>, views.index)</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> auth</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'index.html'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Login</span><span class="params">(View)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">'login.html'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        response = &#123;<span class="string">'status'</span>: <span class="literal">False</span>, <span class="string">'msg'</span>: <span class="literal">None</span>&#125;</span><br><span class="line">        print(request.POST)</span><br><span class="line">        user = request.POST.get(<span class="string">'user'</span>)</span><br><span class="line">        pwd = request.POST.get(<span class="string">'pwd'</span>)</span><br><span class="line">        valid_code = request.POST.get(<span class="string">'valid_code'</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> valid_code.upper() == request.session[<span class="string">'valid_code'</span>].upper():</span><br><span class="line">            response[<span class="string">'msg'</span>] = <span class="string">'验证码错误'</span></span><br><span class="line">            <span class="keyword">return</span> JsonResponse(response, json_dumps_params=&#123;<span class="string">'ensure_ascii'</span>: <span class="literal">False</span>&#125;)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 参数传入用户名和密码，他会去系统表中进行查找，有相同的返回对象，没有就返回None</span></span><br><span class="line">        usr = auth.authenticate(request, username=user, password=pwd)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> usr:</span><br><span class="line">            response[<span class="string">'msg'</span>] = <span class="string">'用户不存在'</span></span><br><span class="line">            <span class="keyword">return</span> JsonResponse(response, json_dumps_params=&#123;<span class="string">'ensure_ascii'</span>: <span class="literal">False</span>&#125;)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            auth.login(request, usr)</span><br><span class="line">            <span class="comment"># 调用login系统相当于做了以下三部</span></span><br><span class="line">            <span class="comment">#   1.设置session和cookie</span></span><br><span class="line">            <span class="comment">#   2.生成request.user对象，这个对象是可以在函数视图中使用的(详情见auth中间件)</span></span><br><span class="line">            <span class="comment">#   3.request.user 相当于request.session</span></span><br><span class="line">            response[<span class="string">'status'</span>] = <span class="literal">True</span></span><br><span class="line">            response[<span class="string">'msg'</span>] = <span class="string">'登录成功'</span></span><br><span class="line">            <span class="keyword">return</span> JsonResponse(response, json_dumps_params=&#123;<span class="string">'ensure_ascii'</span>: <span class="literal">False</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_valid_img</span><span class="params">(request)</span>:</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">get_random_color</span><span class="params">()</span>:</span></span><br><span class="line">            <span class="keyword">import</span> random</span><br><span class="line">            <span class="keyword">return</span> (random.randint(<span class="number">0</span>, <span class="number">255</span>), random.randint(<span class="number">0</span>, <span class="number">255</span>), random.randint(<span class="number">0</span>, <span class="number">255</span>))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">from</span> PIL <span class="keyword">import</span> Image, ImageDraw, ImageFont</span><br><span class="line">        <span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line">        <span class="keyword">import</span> random</span><br><span class="line">        img = Image.new(<span class="string">'RGB'</span>, (<span class="number">270</span>, <span class="number">35</span>), color=get_random_color())</span><br><span class="line"></span><br><span class="line">        draw = ImageDraw.Draw(img)</span><br><span class="line">        kumo_font = ImageFont.truetype(<span class="string">'static/font/大梁体繁简精全2016版(9月版).ttf'</span>, size=<span class="number">28</span>)</span><br><span class="line">        random_num = str(random.randint(<span class="number">0</span>, <span class="number">9</span>))</span><br><span class="line">        random_low_alpha = chr(random.randint(<span class="number">65</span>, <span class="number">90</span>))</span><br><span class="line">        random_upper_alpha = chr(random.randint(<span class="number">97</span>, <span class="number">122</span>))</span><br><span class="line"></span><br><span class="line">        valid_code_str = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">6</span>):</span><br><span class="line">            res = random.choice([random_num, random_low_alpha, random_upper_alpha])</span><br><span class="line">            draw.text([i * <span class="number">40</span> + <span class="number">20</span>, <span class="number">5</span>], res, get_random_color(), font=kumo_font)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 保存验证码字符串</span></span><br><span class="line">            valid_code_str += res</span><br><span class="line"></span><br><span class="line">        print(<span class="number">111111</span>, valid_code_str)</span><br><span class="line">        request.session[<span class="string">'valid_code'</span>] = valid_code_str</span><br><span class="line">        print(request.session)</span><br><span class="line">        <span class="comment"># img.show()</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 设置噪点燥线</span></span><br><span class="line">        width = <span class="number">270</span></span><br><span class="line">        height = <span class="number">35</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">            x1 = random.randint(<span class="number">0</span>, width)</span><br><span class="line">            x2 = random.randint(<span class="number">0</span>, width)</span><br><span class="line">            y1 = random.randint(<span class="number">0</span>, height)</span><br><span class="line">            y2 = random.randint(<span class="number">0</span>, height)</span><br><span class="line">            draw.line((x1, y1, x2, y2), fill=get_random_color())</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">200</span>):</span><br><span class="line">            draw.point([random.randint(<span class="number">0</span>, width), random.randint(<span class="number">0</span>, height)], fill=get_random_color())</span><br><span class="line">            x = random.randint(<span class="number">0</span>, width)</span><br><span class="line">            y = random.randint(<span class="number">0</span>, height)</span><br><span class="line">            draw.arc((x, y, x + <span class="number">1</span>, y + <span class="number">1</span>), <span class="number">0</span>, <span class="number">90</span>, fill=get_random_color())</span><br><span class="line"></span><br><span class="line">        f = BytesIO()</span><br><span class="line">        img.save(f, <span class="string">'png'</span>)</span><br><span class="line">        data = f.getvalue()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(data)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">logout</span><span class="params">(request)</span>:</span></span><br><span class="line">        auth.logout(request)</span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">'/login/'</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_password</span><span class="params">(request)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">            old_password = request.POST.get(<span class="string">'old_password'</span>)</span><br><span class="line">            new_password = request.POST.get(<span class="string">'new_password'</span>)</span><br><span class="line">            <span class="keyword">if</span> request.user.check_password(old_password):</span><br><span class="line">                request.user.set_password(new_password)</span><br><span class="line">                request.user.save()</span><br><span class="line">            <span class="keyword">return</span> redirect(<span class="string">'/login/'</span>)</span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">'set_password.html'</span>)</span><br></pre></td></tr></table></figure>

<p><code>前端业务逻辑</code></p>
<p><code>login.html</code></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">"en"</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">"UTF-8"</span>&gt;</span><br><span class="line">    &lt;meta name=<span class="string">"viewport"</span> content=<span class="string">"width=device-width, initial-scale=1"</span>&gt;</span><br><span class="line">    &lt;title&gt;Title&lt;/title&gt;</span><br><span class="line">    &lt;script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"&gt;&lt;/script&gt;</span><br><span class="line">    &lt;link rel=<span class="string">"stylesheet"</span> href=<span class="string">"/static/blog/bs/css/bootstrap.css"</span>&gt;</span><br><span class="line">    &lt;script src="/static/blog/bs/js/bootstrap.js"&gt;&lt;/script&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body style=<span class="string">"background-color: #cccccc"</span>&gt;</span><br><span class="line">&lt;h3 class="text-info text-center"&gt;登录页面&lt;/h3&gt;</span><br><span class="line">&lt;div class="container" style="margin-top: 26px"&gt;</span><br><span class="line">    &lt;div class="row"&gt;</span><br><span class="line">        &lt;div class="col-md-6 col-md-offset-3"&gt;</span><br><span class="line">            &lt;form&gt;</span><br><span class="line">                &#123;% csrf_token %&#125;</span><br><span class="line">                &lt;div class="form-group"&gt;</span><br><span class="line">                    &lt;label for="user"&gt;用户名&lt;/label&gt;</span><br><span class="line">                    &lt;input type="text" id="user" class="form-control" placeholder="用户名"&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                &lt;div class="form-group"&gt;</span><br><span class="line">                    &lt;label for="pwd"&gt;密码&lt;/label&gt;</span><br><span class="line">                    &lt;input type="password" id="pwd" class="form-control" placeholder="密码"&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                &lt;div&gt;</span><br><span class="line">                    &lt;label for=""&gt;验证码&lt;/label&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                &lt;div class="row"&gt;</span><br><span class="line">                    &lt;div class="col-md-6"&gt;</span><br><span class="line">                        &lt;input type="text" id="valid_code" class="form-control"&gt;</span><br><span class="line">                    &lt;/div&gt;</span><br><span class="line">                    &lt;div class="col-md-6"&gt;</span><br><span class="line">                        &lt;img width=<span class="string">"260"</span> height=<span class="string">"35"</span> src=<span class="string">"/get_valid_img/"</span> id=<span class="string">"valid_code_img"</span> alt=<span class="string">""</span>&gt;</span><br><span class="line">                    &lt;/div&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                &lt;input type="button" class="btn btn-primary login_btn btn-group-justified" style="" value="登录"&gt;</span><br><span class="line">                &lt;span class="error h4 pull-left" style="margin-top: 10px"&gt;&lt;/span&gt;</span><br><span class="line">                &lt;a href="/register/" class="pull-right h4" style="color: rebeccapurple"&gt;注册&lt;/a&gt;</span><br><span class="line">            &lt;/form&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    $(<span class="string">'#valid_code_img'</span>).click(function () &#123;</span><br><span class="line">        $(this)[<span class="number">0</span>].src += <span class="string">'?'</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    $(<span class="string">'.login_btn'</span>).click(function () &#123;</span><br><span class="line">        $.ajax(&#123;</span><br><span class="line">            url: <span class="string">''</span>,</span><br><span class="line">            type: <span class="string">'post'</span>,</span><br><span class="line">            data: &#123;</span><br><span class="line">                user: $(<span class="string">'#user'</span>).val(),</span><br><span class="line">                pwd: $(<span class="string">'#pwd'</span>).val(),</span><br><span class="line">                valid_code: $(<span class="string">'#valid_code'</span>).val(),</span><br><span class="line">                csrfmiddlewaretoken: $(<span class="string">"[name='csrfmiddlewaretoken']"</span>).val()</span><br><span class="line">            &#125;,</span><br><span class="line">            success: function (data) &#123;</span><br><span class="line">                <span class="keyword">if</span> (data.status) &#123;</span><br><span class="line">                    location.href = <span class="string">'/index/'</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    $(<span class="string">'.login_btn'</span>).next().html(data.msg).css(&#123;<span class="string">"color"</span>: <span class="string">"red"</span>&#125;);</span><br><span class="line">                &#125;</span><br><span class="line">                setTimeout(function () &#123;</span><br><span class="line">                    $(<span class="string">'.error'</span>).html(<span class="string">''</span>)</span><br><span class="line">                &#125;, <span class="number">1000</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p><code>set_password.html</code></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">"en"</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">"UTF-8"</span>&gt;</span><br><span class="line">    &lt;meta name=<span class="string">"viewport"</span> content=<span class="string">"width=device-width, initial-scale=1"</span>&gt;</span><br><span class="line">    &lt;title&gt;Title&lt;/title&gt;</span><br><span class="line">    &lt;script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"&gt;&lt;/script&gt;</span><br><span class="line">    &lt;link rel=<span class="string">"stylesheet"</span> href=<span class="string">"/static/app01/bs/css/bootstrap.css"</span>&gt;</span><br><span class="line">    &lt;script src="/static/app01/bs/js/bootstrap.js"&gt;&lt;/script&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body style=<span class="string">"background-color: #cccccc"</span>&gt;</span><br><span class="line">&lt;h3 class="has-error" style="text-align: center"&gt;修改密码&lt;/h3&gt;</span><br><span class="line">&lt;div class="container" style="padding-top: 50px"&gt;</span><br><span class="line">    &lt;div class="row"&gt;</span><br><span class="line">        &lt;div class="col-md-6 col-md-offset-3"&gt;</span><br><span class="line">            &lt;form action=<span class="string">""</span> method=<span class="string">"post"</span>&gt;</span><br><span class="line">                &#123;% csrf_token %&#125;</span><br><span class="line">                &lt;div class="form-group"&gt;</span><br><span class="line">                    &lt;label for="user"&gt;用户名&lt;/label&gt;</span><br><span class="line">                    &lt;input type="text" id="user" class="form-control" value="&#123;&#123; request.user.username &#125;&#125;" disabled&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                &lt;div class="form-group"&gt;</span><br><span class="line">                    &lt;label for="pwd"&gt;旧密码&lt;/label&gt;</span><br><span class="line">                    &lt;input type="password" id="old_password" name="old_password" class="form-control" placeholder="旧密码"&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                &lt;div class="form-group"&gt;</span><br><span class="line">                    &lt;label for="pwd"&gt;新密码&lt;/label&gt;</span><br><span class="line">                    &lt;input type="password" id="new_password" name="new_password" class="form-control" placeholder="新密码"&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                &lt;input type="submit" class="btn btn-primary login_btn btn-group-justified" value="确认修改"</span><br><span class="line">                   style=<span class="string">"margin-top: 10px"</span>&gt;</span><br><span class="line">            &lt;/form&gt;</span><br><span class="line"></span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">    $(<span class="string">'#old_password'</span>).focus(function () &#123;</span><br><span class="line">        $(this).removeAttr(<span class="string">'placeholder'</span>)</span><br><span class="line">    &#125;);</span><br><span class="line">    $(<span class="string">'#new_password'</span>).focus(function () &#123;</span><br><span class="line">        $(this).removeAttr(<span class="string">'placeholder'</span>)</span><br><span class="line">    &#125;);</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<h2 id="后台管理"><a href="#后台管理" class="headerlink" title="后台管理"></a>后台管理</h2><p><code>创建超级用户</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">manage.py@bbs3 &gt; createsuperuser</span><br><span class="line">bash -cl <span class="string">"/usr/local/bin/python3.6 /Applications/PyCharm.app/Contents/helpers/pycharm/django_manage.py createsuperuser /Users/cjw/Desktop/bbs3"</span></span><br><span class="line">Tracking file by folder pattern:  migrations</span><br><span class="line">Username:  cjwnb</span><br><span class="line">Email address:  </span><br><span class="line">Warning: Password input may be echoed.</span><br><span class="line">Password:  cjw123456</span><br><span class="line">Warning: Password input may be echoed.</span><br><span class="line">Password (again):  cjw123456</span><br><span class="line">Superuser created successfully.</span><br><span class="line"></span><br><span class="line">Process finished <span class="keyword">with</span> exit code <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p><code>注册表到admin后台 admin.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> blog <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">admin.site.register(models.Userinfo)</span><br><span class="line">admin.site.register(models.Blog)</span><br><span class="line">admin.site.register(models.Category)</span><br><span class="line">admin.site.register(models.Comment)</span><br><span class="line">admin.site.register(models.Article)</span><br><span class="line">admin.site.register(models.Tag)</span><br><span class="line">admin.site.register(models.Article2tag)</span><br><span class="line">admin.site.register(models.ArticleUpDown)</span><br></pre></td></tr></table></figure>

<p><img src="http://ww4.sinaimg.cn/large/006tNc79ly1g5hvpza8f0j30wm0ge0uh.jpg" alt="image-20190730150623933"></p>
<h2 id="media配置"><a href="#media配置" class="headerlink" title="media配置"></a>media配置</h2><p><code>settings.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">MEDIA_ROOT = os.path.join(BASE_DIR, <span class="string">'media'</span>)</span><br></pre></td></tr></table></figure>

<p><code>urls.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django.views.static <span class="keyword">import</span> serve</span><br><span class="line"><span class="keyword">from</span> BBS <span class="keyword">import</span> settings</span><br><span class="line">url(<span class="string">r'^media/(?P&lt;path&gt;.*)'</span>, serve, &#123;<span class="string">'document_root'</span>: settings.MEDIA_ROOT&#125;),</span><br></pre></td></tr></table></figure>

<p><code>然后注册个用户就会自动生成media目录，最后把所有需要用到的图片都放进media/avata下</code></p>
<h2 id="个人站点功能"><a href="#个人站点功能" class="headerlink" title="个人站点功能"></a>个人站点功能</h2><p><code>urls.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">"""bbs3 URL Configuration</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The `urlpatterns` list routes URLs to views. For more information please see:</span></span><br><span class="line"><span class="string">    https://docs.djangoproject.com/en/1.11/topics/http/urls/</span></span><br><span class="line"><span class="string">Examples:</span></span><br><span class="line"><span class="string">Function views</span></span><br><span class="line"><span class="string">    1. Add an import:  from my_app import views</span></span><br><span class="line"><span class="string">    2. Add a URL to urlpatterns:  url(r'^$', views.home, name='home')</span></span><br><span class="line"><span class="string">Class-based views</span></span><br><span class="line"><span class="string">    1. Add an import:  from other_app.views import Home</span></span><br><span class="line"><span class="string">    2. Add a URL to urlpatterns:  url(r'^$', Home.as_view(), name='home')</span></span><br><span class="line"><span class="string">Including another URLconf</span></span><br><span class="line"><span class="string">    1. Import the include() function: from django.conf.urls import url, include</span></span><br><span class="line"><span class="string">    2. Add a URL to urlpatterns:  url(r'^blog/', include('blog.urls'))</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url</span><br><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> blog <span class="keyword">import</span> views</span><br><span class="line"><span class="keyword">from</span> bbs3 <span class="keyword">import</span> settings</span><br><span class="line"><span class="keyword">from</span> django.views.static <span class="keyword">import</span> serve</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r'^admin/'</span>, admin.site.urls),</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 注册功能</span></span><br><span class="line">    url(<span class="string">r'^register/'</span>, views.Register.as_view()),</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 登录功能</span></span><br><span class="line">    url(<span class="string">r'^login/'</span>, views.Login.as_view()),</span><br><span class="line">    url(<span class="string">r'^get_valid_img/'</span>, views.Login.get_valid_img),</span><br><span class="line">    url(<span class="string">r'^logout/'</span>, views.Login.logout),</span><br><span class="line">    url(<span class="string">r'^set_password/'</span>, views.Login.set_password),</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 主页</span></span><br><span class="line">    url(<span class="string">r'^index/'</span>, views.index),</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 配置media路由</span></span><br><span class="line">    url(<span class="string">r'^media/(?P&lt;path&gt;.*)'</span>, serve, &#123;<span class="string">'document_root'</span>: settings.MEDIA_ROOT&#125;),</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 侧边栏筛选功能</span></span><br><span class="line">    url(<span class="string">r'^(?P&lt;username&gt;\w+)/(?P&lt;conditions&gt;tag|category|archive)/(?P&lt;param&gt;.*)'</span>, views.site),</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 配置文章详情页</span></span><br><span class="line">    url(<span class="string">r'^(?P&lt;username&gt;\w+)/articles/(?P&lt;article_id&gt;\d+)$'</span>, views.article_detail),</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 点赞点踩</span></span><br><span class="line">    url(<span class="string">r'^digg/'</span>, views.digg),</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 父评论页面</span></span><br><span class="line">    url(<span class="string">r'^comment'</span>, views.comment),</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 配置404页面</span></span><br><span class="line">    url(<span class="string">r'^(?P&lt;username&gt;\w+)/$'</span>, views.site),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p><code>views.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db.models.functions <span class="keyword">import</span> TruncMonth</span><br><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render, HttpResponse, redirect</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create your views here.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.views <span class="keyword">import</span> View</span><br><span class="line"><span class="keyword">from</span> blog <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> blog <span class="keyword">import</span> myforms</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> JsonResponse</span><br><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> Count</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="comment"># 查出所有的文章</span></span><br><span class="line">    article_list = models.Article.objects.all()</span><br><span class="line">    category_list = models.Category.objects.annotate(c=Count(<span class="string">'article'</span>)).values_list(<span class="string">'title'</span>, <span class="string">'c'</span>, <span class="string">'nid'</span>,</span><br><span class="line">                                                                                     <span class="string">'blog__userinfo__username'</span>)</span><br><span class="line">    tag_list = models.Tag.objects.annotate(c=Count(<span class="string">'article'</span>)).values_list(<span class="string">'title'</span>, <span class="string">'c'</span>, <span class="string">'nid'</span>,</span><br><span class="line">                                                                           <span class="string">'blog__userinfo__username'</span>)</span><br><span class="line">    month_list = models.Article.objects.annotate(month=TruncMonth(<span class="string">'create_time'</span>)).values(<span class="string">'month'</span>).annotate(</span><br><span class="line">        c=Count(<span class="string">'pk'</span>)).values_list(<span class="string">'month'</span>, <span class="string">'c'</span>, <span class="string">'blog__userinfo__username'</span>)</span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'index.html'</span>, locals())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Register</span><span class="params">(View)</span>:</span></span><br><span class="line">    form = myforms.MyForm()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">'register.html'</span>, &#123;<span class="string">'form'</span>: self.form&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        <span class="comment"># 前端提交后进行校验，提交就是post请求</span></span><br><span class="line">        <span class="comment"># &#123;'csrfmiddlewaretoken': ['FELJgdjWNKdUXizMQ2GAqF6QMtZxYHvquEXJodcjrL8GRaVBknZ8VINjud6bX52X'],</span></span><br><span class="line">        <span class="comment">#  'username': ['lxx'],</span></span><br><span class="line">        <span class="comment">#  'password': ['123'],</span></span><br><span class="line">        <span class="comment">#  'confirm_password': ['123'],</span></span><br><span class="line">        <span class="comment">#  'email': ['123@qq.com']&#125;</span></span><br><span class="line">        response = &#123;<span class="string">'status'</span>: <span class="literal">False</span>, <span class="string">'msg'</span>: <span class="literal">None</span>&#125;</span><br><span class="line">        form = myforms.MyForm(request.POST)</span><br><span class="line">        print(form.is_valid())</span><br><span class="line">        print(form.cleaned_data)</span><br><span class="line">        <span class="keyword">if</span> form.is_valid():</span><br><span class="line">            <span class="comment"># 校验通过，数据库查数据</span></span><br><span class="line">            response[<span class="string">'status'</span>] = <span class="literal">True</span></span><br><span class="line">            response[<span class="string">'msg'</span>] = <span class="string">'注册成功'</span></span><br><span class="line">            <span class="comment"># &#123;'username': 'lxx', 'password': '123', 'confirm_password': '123', 'email': '123@qq.com'&#125;</span></span><br><span class="line">            clean_data = form.cleaned_data</span><br><span class="line">            clean_data.pop(<span class="string">'confirm_password'</span>)  <span class="comment"># &#123;'username': 'lxx', 'password': '123', 'email': '123@qq.com'&#125;</span></span><br><span class="line">            <span class="keyword">if</span> request.FILES:</span><br><span class="line">                <span class="comment"># &lt; MultiValueDict: &#123;'file_obj': [ &lt; InMemoryUploadedFile: timg.jpeg(image / jpeg) &gt;]&#125; &gt;</span></span><br><span class="line">                clean_data[<span class="string">'avatar'</span>] = request.FILES.get(<span class="string">'file_obj'</span>)</span><br><span class="line">            <span class="comment"># 前面数据准备成功了，写入数据库</span></span><br><span class="line">            <span class="comment"># &#123;'username': 'lxx', 'password': '123', 'email': '123@qq.com', 'avatar': &lt; InMemoryUploadedFile: timg.jpeg(image / jpeg) &gt;&#125;</span></span><br><span class="line">            models.Userinfo.objects.create_user(**clean_data)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 校验不通过，返回错误信息</span></span><br><span class="line">            response[<span class="string">'msg'</span>] = form.errors</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> JsonResponse(response, json_dumps_params=&#123;<span class="string">'ensure_ascii'</span>: <span class="literal">False</span>&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> auth</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Login</span><span class="params">(View)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">'login.html'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        response = &#123;<span class="string">'status'</span>: <span class="literal">False</span>, <span class="string">'msg'</span>: <span class="literal">None</span>&#125;</span><br><span class="line">        print(request.POST)</span><br><span class="line">        user = request.POST.get(<span class="string">'user'</span>)</span><br><span class="line">        pwd = request.POST.get(<span class="string">'pwd'</span>)</span><br><span class="line">        valid_code = request.POST.get(<span class="string">'valid_code'</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> valid_code.upper() == request.session[<span class="string">'valid_code'</span>].upper():</span><br><span class="line">            response[<span class="string">'msg'</span>] = <span class="string">'验证码错误'</span></span><br><span class="line">            <span class="keyword">return</span> JsonResponse(response, json_dumps_params=&#123;<span class="string">'ensure_ascii'</span>: <span class="literal">False</span>&#125;)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 参数传入用户名和密码，他会去系统表中进行查找，有相同的返回对象，没有就返回None</span></span><br><span class="line">        usr = auth.authenticate(request, username=user, password=pwd)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> usr:</span><br><span class="line">            response[<span class="string">'msg'</span>] = <span class="string">'用户不存在'</span></span><br><span class="line">            <span class="keyword">return</span> JsonResponse(response, json_dumps_params=&#123;<span class="string">'ensure_ascii'</span>: <span class="literal">False</span>&#125;)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            auth.login(request, usr)</span><br><span class="line">            <span class="comment"># 调用login系统相当于做了以下三部</span></span><br><span class="line">            <span class="comment">#   1.设置session和cookie</span></span><br><span class="line">            <span class="comment">#   2.生成request.user对象，这个对象是可以在函数视图中使用的(详情见auth中间件)</span></span><br><span class="line">            <span class="comment">#   3.request.user 相当于request.session</span></span><br><span class="line">            response[<span class="string">'status'</span>] = <span class="literal">True</span></span><br><span class="line">            response[<span class="string">'msg'</span>] = <span class="string">'登录成功'</span></span><br><span class="line">            <span class="keyword">return</span> JsonResponse(response, json_dumps_params=&#123;<span class="string">'ensure_ascii'</span>: <span class="literal">False</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_valid_img</span><span class="params">(request)</span>:</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">get_random_color</span><span class="params">()</span>:</span></span><br><span class="line">            <span class="keyword">import</span> random</span><br><span class="line">            <span class="keyword">return</span> (random.randint(<span class="number">0</span>, <span class="number">255</span>), random.randint(<span class="number">0</span>, <span class="number">255</span>), random.randint(<span class="number">0</span>, <span class="number">255</span>))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">from</span> PIL <span class="keyword">import</span> Image, ImageDraw, ImageFont</span><br><span class="line">        <span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line">        <span class="keyword">import</span> random</span><br><span class="line">        img = Image.new(<span class="string">'RGB'</span>, (<span class="number">270</span>, <span class="number">35</span>), color=get_random_color())</span><br><span class="line"></span><br><span class="line">        draw = ImageDraw.Draw(img)</span><br><span class="line">        kumo_font = ImageFont.truetype(<span class="string">'static/font/大梁体繁简精全2016版(9月版).ttf'</span>, size=<span class="number">28</span>)</span><br><span class="line">        random_num = str(random.randint(<span class="number">0</span>, <span class="number">9</span>))</span><br><span class="line">        random_low_alpha = chr(random.randint(<span class="number">65</span>, <span class="number">90</span>))</span><br><span class="line">        random_upper_alpha = chr(random.randint(<span class="number">97</span>, <span class="number">122</span>))</span><br><span class="line"></span><br><span class="line">        valid_code_str = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">6</span>):</span><br><span class="line">            res = random.choice([random_num, random_low_alpha, random_upper_alpha])</span><br><span class="line">            draw.text([i * <span class="number">40</span> + <span class="number">20</span>, <span class="number">5</span>], res, get_random_color(), font=kumo_font)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 保存验证码字符串</span></span><br><span class="line">            valid_code_str += res</span><br><span class="line"></span><br><span class="line">        print(<span class="number">111111</span>, valid_code_str)</span><br><span class="line">        request.session[<span class="string">'valid_code'</span>] = valid_code_str</span><br><span class="line">        print(request.session)</span><br><span class="line">        <span class="comment"># img.show()</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 设置噪点燥线</span></span><br><span class="line">        width = <span class="number">270</span></span><br><span class="line">        height = <span class="number">35</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">            x1 = random.randint(<span class="number">0</span>, width)</span><br><span class="line">            x2 = random.randint(<span class="number">0</span>, width)</span><br><span class="line">            y1 = random.randint(<span class="number">0</span>, height)</span><br><span class="line">            y2 = random.randint(<span class="number">0</span>, height)</span><br><span class="line">            draw.line((x1, y1, x2, y2), fill=get_random_color())</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">200</span>):</span><br><span class="line">            draw.point([random.randint(<span class="number">0</span>, width), random.randint(<span class="number">0</span>, height)], fill=get_random_color())</span><br><span class="line">            x = random.randint(<span class="number">0</span>, width)</span><br><span class="line">            y = random.randint(<span class="number">0</span>, height)</span><br><span class="line">            draw.arc((x, y, x + <span class="number">1</span>, y + <span class="number">1</span>), <span class="number">0</span>, <span class="number">90</span>, fill=get_random_color())</span><br><span class="line"></span><br><span class="line">        f = BytesIO()</span><br><span class="line">        img.save(f, <span class="string">'png'</span>)</span><br><span class="line">        data = f.getvalue()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(data)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">logout</span><span class="params">(request)</span>:</span></span><br><span class="line">        auth.logout(request)</span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">'/login/'</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_password</span><span class="params">(request)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">            old_password = request.POST.get(<span class="string">'old_password'</span>)</span><br><span class="line">            new_password = request.POST.get(<span class="string">'new_password'</span>)</span><br><span class="line">            <span class="keyword">if</span> request.user.check_password(old_password):</span><br><span class="line">                request.user.set_password(new_password)</span><br><span class="line">                request.user.save()</span><br><span class="line">            <span class="keyword">return</span> redirect(<span class="string">'/login/'</span>)</span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">'set_password.html'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">site</span><span class="params">(request, username, **kwargs)</span>:</span></span><br><span class="line">    blog = models.Blog.objects.filter(site_name=username).first()</span><br><span class="line">    print(blog)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> blog:</span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">'error.html'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        article_list = models.Article.objects.filter(blog=blog)</span><br><span class="line">        category_list = models.Category.objects.filter(blog=blog).annotate(c=Count(<span class="string">'article'</span>)).values_list(<span class="string">'title'</span>, <span class="string">'c'</span>,</span><br><span class="line">                                                                                                           <span class="string">'nid'</span>)</span><br><span class="line">        tag_list = models.Tag.objects.annotate(c=Count(<span class="string">'article'</span>)).values_list(<span class="string">'title'</span>, <span class="string">'c'</span>, <span class="string">'nid'</span>)</span><br><span class="line">        month_list = models.Article.objects.filter(blog=blog).annotate(month=TruncMonth(<span class="string">'create_time'</span>)).values(</span><br><span class="line">            <span class="string">'month'</span>).annotate(c=Count(<span class="string">'pk'</span>)).values_list(<span class="string">'month'</span>, <span class="string">'c'</span>)</span><br><span class="line">        print(tag_list)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> kwargs:</span><br><span class="line">        conditions = kwargs.get(<span class="string">'conditions'</span>)</span><br><span class="line">        param = kwargs.get(<span class="string">'param'</span>)</span><br><span class="line">        <span class="keyword">if</span> conditions == <span class="string">'category'</span>:</span><br><span class="line">            article_list = article_list.filter(category=param)</span><br><span class="line">        <span class="keyword">if</span> conditions == <span class="string">'tag'</span>:</span><br><span class="line">            article_list = article_list.filter(tags=param)</span><br><span class="line">        <span class="keyword">if</span> conditions == <span class="string">'archive'</span>:</span><br><span class="line">            year, month = param.split(<span class="string">'/'</span>)</span><br><span class="line">            article_list = article_list.filter(create_time__year=year, create_time__month=month)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'site.html'</span>, locals())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">article_detail</span><span class="params">(request, username, article_id)</span>:</span></span><br><span class="line">    article_obj = models.Article.objects.filter(nid=article_id).first()</span><br><span class="line">    blog = article_obj.blog</span><br><span class="line">    comment_list = models.Comment.objects.filter(article=article_obj)</span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'article_detail.html'</span>, locals())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 点赞视图函数</span></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> F</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">digg</span><span class="params">(request)</span>:</span></span><br><span class="line">    print(request.POST)</span><br><span class="line">    article_id = request.POST.get(<span class="string">'article_id'</span>)</span><br><span class="line"></span><br><span class="line">    print(<span class="string">'article_id'</span>, article_id)</span><br><span class="line">    <span class="comment"># 点赞人就是当前登录人</span></span><br><span class="line">    user_id = request.user.pk</span><br><span class="line">    print(user_id)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 生成点赞记录</span></span><br><span class="line">    send_dic = &#123;<span class="string">'state'</span>: <span class="literal">False</span>, <span class="string">'msg'</span>: <span class="literal">None</span>&#125;</span><br><span class="line">    <span class="comment"># 判断用户没有登录</span></span><br><span class="line">    print(<span class="number">11111111</span>, request.user.is_authenticated)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> request.user.is_authenticated:</span><br><span class="line">        send_dic[<span class="string">'msg'</span>] = <span class="string">'你未登录'</span></span><br><span class="line">        <span class="keyword">return</span> JsonResponse(send_dic, json_dumps_params=&#123;<span class="string">'ensure_ascii'</span>: <span class="literal">False</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 下面的情况用户都是登录的</span></span><br><span class="line">    <span class="comment"># 登录用户就是文章的作者</span></span><br><span class="line">    <span class="keyword">if</span> request.user.username == models.Article.objects.filter(pk=article_id).first().blog.userinfo.username:</span><br><span class="line">        print(<span class="number">1111</span>, request.user)</span><br><span class="line">        print(<span class="number">2222</span>, models.Article.objects.filter(pk=article_id).first().blog.userinfo.username)</span><br><span class="line">        send_dic[<span class="string">'msg'</span>] = <span class="string">'臭不要脸，给自己点赞'</span></span><br><span class="line">        <span class="keyword">return</span> JsonResponse(send_dic, json_dumps_params=&#123;<span class="string">'ensure_ascii'</span>: <span class="literal">False</span>&#125;)</span><br><span class="line"></span><br><span class="line">    is_up = json.loads(request.POST.get(<span class="string">'is_up'</span>))</span><br><span class="line">    obj = models.ArticleUpDown.objects.filter(user_id=user_id, article_id=article_id)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> obj:</span><br><span class="line">        models.ArticleUpDown.objects.create(user_id=user_id, article_id=article_id)</span><br><span class="line">        query_set = models.Article.objects.filter(pk=article_id)</span><br><span class="line">        <span class="keyword">if</span> is_up:</span><br><span class="line">            query_set.update(up_count=F(<span class="string">'up_count'</span>) + <span class="number">1</span>)</span><br><span class="line">            send_dic[<span class="string">'state'</span>] = <span class="literal">True</span></span><br><span class="line">            send_dic[<span class="string">'msg'</span>] = <span class="string">'点赞成功'</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            query_set.update(down_count=F(<span class="string">'down_count'</span>) + <span class="number">1</span>)</span><br><span class="line">            send_dic[<span class="string">'state'</span>] = <span class="literal">True</span></span><br><span class="line">            send_dic[<span class="string">'msg'</span>] = <span class="string">'点踩成功'</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        send_dic[<span class="string">'msg'</span>] = <span class="string">'你已经点过赞'</span></span><br><span class="line">    <span class="keyword">return</span> JsonResponse(send_dic, json_dumps_params=&#123;<span class="string">'ensure_ascii'</span>: <span class="literal">False</span>&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 评论视图函数</span></span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> transaction</span><br><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> F</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.decorators <span class="keyword">import</span> login_required</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@login_required(login_url='/login/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">comment</span><span class="params">(request)</span>:</span></span><br><span class="line">    send_dic = &#123;<span class="string">'state'</span>: <span class="literal">False</span>, <span class="string">'msg'</span>: <span class="literal">None</span>&#125;</span><br><span class="line">    <span class="keyword">if</span> request.is_ajax():</span><br><span class="line">        print(request.POST)</span><br><span class="line">        <span class="comment"># &#123;'comment': ['dfddffd'], 'article_id': ['2'],&#125;</span></span><br><span class="line">        parent_id = request.POST.get(<span class="string">'parent_id'</span>)</span><br><span class="line">        comment = request.POST.get(<span class="string">'comment'</span>)</span><br><span class="line">        article_id = request.POST.get(<span class="string">'article_id'</span>)</span><br><span class="line">        user_id = request.user.pk</span><br><span class="line">        <span class="keyword">with</span> transaction.atomic():</span><br><span class="line">            <span class="comment"># 写入数据库</span></span><br><span class="line">            models.Comment.objects.create(content=comment, article_id=article_id, user_id=user_id, parent_comment_id=parent_id)</span><br><span class="line">            models.Article.objects.filter(pk=article_id).update(comment_count=F(<span class="string">'comment_count'</span>) + <span class="number">1</span>)</span><br><span class="line">        send_dic[<span class="string">'state'</span>] = <span class="literal">True</span></span><br><span class="line">        send_dic[<span class="string">'msg'</span>] = <span class="string">'评论成功'</span></span><br><span class="line">    <span class="keyword">return</span> JsonResponse(send_dic, json_dumps_params=&#123;<span class="string">'ensure_ascii'</span>: <span class="literal">False</span>&#125;)</span><br></pre></td></tr></table></figure>

<p><code>base.html</code></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">"en"</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">"UTF-8"</span>&gt;</span><br><span class="line">    &lt;meta name=<span class="string">"viewport"</span> content=<span class="string">"width=device-width, initial-scale=1"</span>&gt;</span><br><span class="line">    &lt;title&gt;Title&lt;/title&gt;</span><br><span class="line">    &lt;script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"&gt;&lt;/script&gt;</span><br><span class="line">    &lt;link rel=<span class="string">"stylesheet"</span> href=<span class="string">"/static/blog/bs/css/bootstrap.css"</span>&gt;</span><br><span class="line">    &lt;script src="/static/blog/bs/js/bootstrap.js"&gt;&lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&#123;<span class="comment">#&lt;h2&gt;hi, &#123;&#123; request.user &#125;&#125;&lt;/h2&gt;#&#125;</span></span><br><span class="line">&lt;nav class="navbar navbar-inverse"&gt;</span><br><span class="line">    &lt;div class="container-fluid"&gt;</span><br><span class="line">        &lt;!-- Brand and toggle get grouped for better mobile display --&gt;</span><br><span class="line">        &lt;div class="navbar-header"&gt;</span><br><span class="line">            &lt;button type="button" class="navbar-toggle collapsed" data-toggle="collapse"</span><br><span class="line">                    data-target=<span class="string">"#bs-example-navbar-collapse-1"</span> aria-expanded=<span class="string">"false"</span>&gt;</span><br><span class="line">                &lt;span class="sr-only"&gt;Toggle navigation&lt;/span&gt;</span><br><span class="line">                &lt;span class="icon-bar"&gt;&lt;/span&gt;</span><br><span class="line">                &lt;span class="icon-bar"&gt;&lt;/span&gt;</span><br><span class="line">                &lt;span class="icon-bar"&gt;&lt;/span&gt;</span><br><span class="line">            &lt;/button&gt;</span><br><span class="line">             &lt;a class="navbar-brand" href="/index/"&gt;首页&lt;/a&gt;</span><br><span class="line">            &lt;a class="navbar-brand" href="/&#123;&#123; user.username &#125;&#125;/"&gt;&#123;&#123; user.blog.title &#125;&#125;的页面&lt;/a&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- Collect the nav links, forms, and other content for toggling --&gt;</span><br><span class="line">        &lt;div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1"&gt;</span><br><span class="line">            &lt;ul class="nav navbar-nav navbar-right"&gt;</span><br><span class="line">                &#123;% <span class="keyword">if</span> request.user.is_authenticated %&#125;</span><br><span class="line">                    &lt;li&gt;&lt;a href="#"&gt;&#123;&#123; request.user.username &#125;&#125;&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">                    &lt;li class="dropdown"&gt;</span><br><span class="line">                    &lt;a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true"</span><br><span class="line">                       aria-expanded="false"&gt;更多操作 &lt;span class="caret"&gt;&lt;/span&gt;&lt;/a&gt;</span><br><span class="line">                    &lt;ul class="dropdown-menu"&gt;</span><br><span class="line">                    &lt;li&gt;&lt;a href="/set_password/"&gt;修改密码&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">                    &lt;li&gt;&lt;a href="#"&gt;修改头像&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">                    &lt;li role="separator" class="divider"&gt;&lt;/li&gt;</span><br><span class="line">                    &lt;li&gt;&lt;a href="/logout/"&gt;注销&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">                &#123;% <span class="keyword">else</span> %&#125;</span><br><span class="line">                    &lt;li&gt;&lt;a href="/login/"&gt;登录&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">                    &lt;li&gt;&lt;a href="/register/"&gt;注册&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">                &#123;% endif %&#125;</span><br><span class="line">                &lt;/ul&gt;</span><br><span class="line">                &lt;/li&gt;</span><br><span class="line">            &lt;/ul&gt;</span><br><span class="line">        &lt;/div&gt;&lt;!-- /.navbar-collapse --&gt;</span><br><span class="line">    &lt;/div&gt;&lt;!-- /.container-fluid --&gt;</span><br><span class="line">&lt;/nav&gt;</span><br><span class="line">&lt;div class="container-fluid"&gt;</span><br><span class="line">    &lt;div class="row"&gt;</span><br><span class="line">        &#123;% block css %&#125;</span><br><span class="line"></span><br><span class="line">        &#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">        &#123;% block content %&#125;</span><br><span class="line"></span><br><span class="line">        &#123;% endblock %&#125;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p><code>site.html</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;% extends <span class="string">'base.html'</span> %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">    &lt;div class="col-md-3"&gt;</span><br><span class="line">        &#123;% load mytags %&#125;</span><br><span class="line">        &#123;% get_classification_style username %&#125;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;div class="col-md-9"&gt;</span><br><span class="line">        &#123;% <span class="keyword">for</span> article <span class="keyword">in</span> article_list %&#125;</span><br><span class="line">            &lt;div class="media"&gt;</span><br><span class="line">                &lt;div class="media-left"&gt;</span><br><span class="line">                    &lt;a href=<span class="string">"#"</span>&gt;</span><br><span class="line">                        &lt;img class="media-object" src="/media/&#123;&#123; article.blog.userinfo.avatar &#125;&#125;" alt="..." width="60"&gt;</span><br><span class="line">                    &lt;/a&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                &lt;div class="media-body"&gt;</span><br><span class="line">                    &lt;h4 class="media-heading"&gt;&lt;a</span><br><span class="line">                            href="/&#123;&#123; username &#125;&#125;/articles/&#123;&#123; article.pk &#125;&#125;"&gt;&#123;&#123; article.title &#125;&#125;&lt;/a&gt;&lt;/h4&gt;</span><br><span class="line">                    &lt;p&gt;&#123;&#123; article.desc &#125;&#125;&lt;/p&gt;</span><br><span class="line">                    &lt;div class="pull-right"&gt;</span><br><span class="line">                        &lt;span&gt;posted @&amp;nbsp;&#123;&#123; article.create_time|date:"Y-m-d h:m:s" &#125;&#125;&amp;nbsp;&lt;/span&gt;</span><br><span class="line">                        &lt;span&gt;&#123;&#123; article.blog.userinfo.username &#125;&#125;&amp;nbsp;&lt;/span&gt;</span><br><span class="line">                        &lt;span&gt;评论(&#123;&#123; article.comment_count &#125;&#125;)&amp;nbsp;&lt;/span&gt;</span><br><span class="line">                        &lt;span&gt;点赞(&#123;&#123; article.down_count &#125;&#125;)&lt;/span&gt;</span><br><span class="line">                        &lt;span&gt;&lt;a href=""&gt;编辑&lt;/a&gt;&lt;/span&gt;</span><br><span class="line">                    &lt;/div&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &lt;hr&gt;</span><br><span class="line">        &#123;% endfor %&#125;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>

<p><code>error.html</code></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;!DOCTYPE HTML PUBLIC <span class="string">"-//W3C//DTD HTML 4.01 Transitional//EN"</span>&gt;</span><br><span class="line">&lt;html lang=<span class="string">"zh-cn"</span>&gt;</span><br><span class="line"></span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta http-equiv=<span class="string">"Page-Enter"</span> content=<span class="string">"blendTrans(Duration=0.5)"</span>&gt;</span><br><span class="line">    &lt;meta http-equiv=<span class="string">"Page-Exit"</span> content=<span class="string">"blendTrans(Duration=0.5)"</span>&gt;</span><br><span class="line">    &lt;meta http-equiv=<span class="string">"Content-Type"</span> content=<span class="string">"text/html; charset=utf-8"</span>&gt;</span><br><span class="line">    &lt;title&gt;出错啦! - 你做了什么&lt;/title&gt;</span><br><span class="line">    &lt;style type=<span class="string">"text/css"</span>&gt;</span><br><span class="line">        body &#123;</span><br><span class="line">            vertical-align: middle;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        div.center &#123;</span><br><span class="line">            position: absolute;</span><br><span class="line">            top: <span class="number">50</span>%;</span><br><span class="line">            left: <span class="number">50</span>%;</span><br><span class="line">            margin: <span class="number">-25</span>% <span class="number">0</span> <span class="number">0</span> <span class="number">-320</span>px;</span><br><span class="line">            width: <span class="number">640</span>px;</span><br><span class="line">            min-height: <span class="number">427</span>px;</span><br><span class="line">            padding: <span class="number">0</span>px;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        div.errmsg &#123;</span><br><span class="line">            text-align: left;</span><br><span class="line">            width: <span class="number">640</span>px;</span><br><span class="line">            line-height: <span class="number">150</span>%;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        a &#123;</span><br><span class="line">            text-decoration: none;</span><br><span class="line">            color: red</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        .center &#123;</span><br><span class="line">            display: none</span><br><span class="line">        &#125;</span><br><span class="line">    &lt;/style&gt;</span><br><span class="line">    &lt;link rel=<span class="string">"shortcut icon"</span> href=<span class="string">"//static.hdslb.com/images/favicon.ico"</span>&gt;</span><br><span class="line">    &lt;link href=<span class="string">"//static.hdslb.com/error/dist/error.css"</span> rel=<span class="string">"stylesheet"</span>&gt;</span><br><span class="line">    &lt;script type=<span class="string">"text/javascript"</span>&gt;</span><br><span class="line">        var options = &#123;</span><br><span class="line">            type: <span class="string">'defaultError'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &lt;/script&gt;</span><br><span class="line">    &lt;script type="text/javascript" src="//s1.hdslb.com/bfs/static/jinkela/long/js/jquery/jquery1.7.2.min.js"&gt;&lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body style=<span class="string">"direction: ltr;"</span>&gt;</span><br><span class="line">    &lt;div class="z-top-container"&gt;&lt;/div&gt;</span><br><span class="line">    &lt;div class="error-container"&gt;</span><br><span class="line">        &lt;div class="error-panel server-error"&gt;</span><br><span class="line">            &lt;img src=<span class="string">"//static.hdslb.com/error/very_sorry.png"</span>&gt;</span><br><span class="line">            &lt;div&gt;</span><br><span class="line">                &lt;div class="left-panel"&gt;</span><br><span class="line">                    &lt;a href="/index/" class="rollback-btn"&gt;返回上一页&lt;/a&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                &lt;div class="right-panel"&gt;</span><br><span class="line">                    &lt;b&gt;错误号:&lt;/b&gt; 404&amp;nbsp;&amp;nbsp;&lt;br /&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div class="error-split"&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div class="error-manga"&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line"></span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p><code>classfication.html</code></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;div&gt;</span><br><span class="line">    &lt;div class="panel panel-success"&gt;</span><br><span class="line">        &lt;div class="panel-heading"&gt;</span><br><span class="line">            &lt;h3 class="panel-title"&gt;文章分类&lt;/h3&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div class="panel-body"&gt;</span><br><span class="line">            &#123;% <span class="keyword">for</span> category <span class="keyword">in</span> category_list %&#125;</span><br><span class="line">                &lt;p&gt;&lt;a href="/&#123;&#123; username &#125;&#125;/category/&#123;&#123; category.2 &#125;&#125;"&gt;&#123;&#123; category.0 &#125;&#125;&lt;/a&gt;&amp;nbsp;(&#123;&#123; category.1 &#125;&#125;)&lt;/p&gt;</span><br><span class="line">            &#123;% endfor %&#125;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;div class="panel panel-danger"&gt;</span><br><span class="line">        &lt;div class="panel-heading"&gt;</span><br><span class="line">            &lt;h3 class="panel-title"&gt;文章标签&lt;/h3&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div class="panel-body"&gt;</span><br><span class="line">            &#123;% <span class="keyword">for</span> tag <span class="keyword">in</span> tag_list %&#125;</span><br><span class="line">                &lt;p&gt;&lt;a href="/&#123;&#123; username &#125;&#125;/tag/&#123;&#123; tag.2 &#125;&#125;"&gt;&#123;&#123; tag.0 &#125;&#125;&lt;/a&gt;&amp;nbsp;(&#123;&#123; tag.1 &#125;&#125;)&lt;/p&gt;</span><br><span class="line">            &#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;div class="panel panel-info"&gt;</span><br><span class="line">        &lt;div class="panel-heading"&gt;</span><br><span class="line">            &lt;h3 class="panel-title"&gt;日期归档 &lt;/h3&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div class="panel-body"&gt;</span><br><span class="line">            &#123;% <span class="keyword">for</span> month <span class="keyword">in</span> month_list %&#125;</span><br><span class="line">                &lt;p&gt;</span><br><span class="line">                    &lt;a href="/&#123;&#123; username &#125;&#125;/archive/&#123;&#123; month.0|date:'Y/m' &#125;&#125;"&gt;&#123;&#123; month.0 |date:'Y年m月' &#125;&#125;&lt;/a&gt;&amp;nbsp;(&#123;&#123; month.1 &#125;&#125;)</span><br><span class="line">                &lt;/p&gt;</span><br><span class="line">            &#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<h2 id="后台管理-1"><a href="#后台管理-1" class="headerlink" title="后台管理"></a>后台管理</h2><p><code>urls.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">"""bbs3 URL Configuration</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The `urlpatterns` list routes URLs to views. For more information please see:</span></span><br><span class="line"><span class="string">    https://docs.djangoproject.com/en/1.11/topics/http/urls/</span></span><br><span class="line"><span class="string">Examples:</span></span><br><span class="line"><span class="string">Function views</span></span><br><span class="line"><span class="string">    1. Add an import:  from my_app import views</span></span><br><span class="line"><span class="string">    2. Add a URL to urlpatterns:  url(r'^$', views.home, name='home')</span></span><br><span class="line"><span class="string">Class-based views</span></span><br><span class="line"><span class="string">    1. Add an import:  from other_app.views import Home</span></span><br><span class="line"><span class="string">    2. Add a URL to urlpatterns:  url(r'^$', Home.as_view(), name='home')</span></span><br><span class="line"><span class="string">Including another URLconf</span></span><br><span class="line"><span class="string">    1. Import the include() function: from django.conf.urls import url, include</span></span><br><span class="line"><span class="string">    2. Add a URL to urlpatterns:  url(r'^blog/', include('blog.urls'))</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url</span><br><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> blog <span class="keyword">import</span> views</span><br><span class="line"><span class="keyword">from</span> bbs3 <span class="keyword">import</span> settings</span><br><span class="line"><span class="keyword">from</span> django.views.static <span class="keyword">import</span> serve</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r'^admin/'</span>, admin.site.urls),</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 注册功能</span></span><br><span class="line">    url(<span class="string">r'^register/'</span>, views.Register.as_view()),</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 登录功能</span></span><br><span class="line">    url(<span class="string">r'^login/'</span>, views.Login.as_view()),</span><br><span class="line">    url(<span class="string">r'^get_valid_img/'</span>, views.Login.get_valid_img),</span><br><span class="line">    url(<span class="string">r'^logout/'</span>, views.Login.logout),</span><br><span class="line">    url(<span class="string">r'^set_password/'</span>, views.Login.set_password),</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 主页</span></span><br><span class="line">    url(<span class="string">r'^index/'</span>, views.index),</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 配置media路由</span></span><br><span class="line">    url(<span class="string">r'^media/(?P&lt;path&gt;.*)'</span>, serve, &#123;<span class="string">'document_root'</span>: settings.MEDIA_ROOT&#125;),</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 侧边栏筛选功能</span></span><br><span class="line">    url(<span class="string">r'^(?P&lt;username&gt;\w+)/(?P&lt;conditions&gt;tag|category|archive)/(?P&lt;param&gt;.*)'</span>, views.site),</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 配置文章详情页</span></span><br><span class="line">    url(<span class="string">r'^(?P&lt;username&gt;\w+)/articles/(?P&lt;article_id&gt;\d+)$'</span>, views.article_detail),</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 点赞点踩</span></span><br><span class="line">    url(<span class="string">r'^digg/'</span>, views.digg),</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 父评论页面</span></span><br><span class="line">    url(<span class="string">r'^comment'</span>, views.comment),</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 后台管理</span></span><br><span class="line">    url(<span class="string">r'^backend/$'</span>, views.backend),</span><br><span class="line">    url(<span class="string">r'^add_article/$'</span>, views.add_article),</span><br><span class="line">    url(<span class="string">r'^upload_img/$'</span>, views.upload_img),</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 配置404页面</span></span><br><span class="line">    url(<span class="string">r'^(?P&lt;username&gt;\w+)/$'</span>, views.site),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p><code>views.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render, HttpResponse, redirect</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create your views here.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> blog <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> JsonResponse</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> blog.utils.my_page <span class="keyword">import</span> Pagination</span><br><span class="line"></span><br><span class="line"><span class="meta">@login_required(login_url='/login/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">backend</span><span class="params">(request)</span>:</span></span><br><span class="line">    print(request.user.blog)</span><br><span class="line">    article_list = models.Article.objects.filter(blog=request.user.blog)</span><br><span class="line">    print(article_list.query)</span><br><span class="line">    page_obj = Pagination(current_page=request.GET.get(<span class="string">'page'</span>, <span class="number">1</span>), all_count=article_list.count())</span><br><span class="line">    page_queryset = article_list[page_obj.start:page_obj.end]</span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'backend/backend.html'</span>, locals())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_article</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">        print(request.POST)</span><br><span class="line">        title = request.POST.get(<span class="string">'title'</span>)</span><br><span class="line">        content = request.POST.get(<span class="string">'content'</span>)</span><br><span class="line">        <span class="comment"># 能够帮我拿到当前用户写的所有的标签 将script删除</span></span><br><span class="line">        res = BeautifulSoup(content, <span class="string">'html.parser'</span>)</span><br><span class="line">        print(type(res))</span><br><span class="line">        tags = res.find_all()</span><br><span class="line">        print(<span class="number">0000</span>, tags)</span><br><span class="line">        <span class="keyword">for</span> tag <span class="keyword">in</span> tags:</span><br><span class="line">            print(<span class="number">1111</span>, tag.name, type(tag.name))</span><br><span class="line">            <span class="comment"># 将script全部删除</span></span><br><span class="line">            <span class="keyword">if</span> tag.name == <span class="string">"script"</span>:</span><br><span class="line">                tag.decompose()  <span class="comment"># 删除指定的标签</span></span><br><span class="line">                print(<span class="number">2222</span>, tag.name)</span><br><span class="line">        desc = res.text[<span class="number">0</span>:<span class="number">150</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 写入数据库</span></span><br><span class="line">        models.Article.objects.create(title=title, content=str(res), desc=desc, blog=request.user.blog)</span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">'/backend/backend.html'</span>)</span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'backend/add_article.html'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> bbs3 <span class="keyword">import</span> settings</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload_img</span><span class="params">(request)</span>:</span></span><br><span class="line">    back_dic = &#123;<span class="string">'error'</span>: <span class="string">''</span>&#125;</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">        print(request.FILES)</span><br><span class="line">        img_obj = request.FILES.get(<span class="string">'imgFile'</span>)</span><br><span class="line">        <span class="comment"># 规定编辑器上传的图片全部放到media文件夹里面的upload_img文件夹下</span></span><br><span class="line">        <span class="comment"># 1.将文件存储到media文件夹下</span></span><br><span class="line">        path = os.path.join(settings.BASE_DIR, <span class="string">'media'</span>, <span class="string">'upload_img'</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(path):</span><br><span class="line">            os.mkdir(path)</span><br><span class="line">        file_path = os.path.join(path, img_obj.name)</span><br><span class="line">        <span class="keyword">with</span> open(file_path, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            <span class="keyword">for</span> line <span class="keyword">in</span> img_obj:</span><br><span class="line">                f.write(line)</span><br><span class="line">        <span class="comment"># 2.将文件路径返回给前端</span></span><br><span class="line">        back_dic[<span class="string">'error'</span>] = <span class="number">0</span></span><br><span class="line">        back_dic[<span class="string">'url'</span>] = <span class="string">'/media/upload_img/%s'</span> % img_obj.name</span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        //成功时</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">                "error" : 0,</span></span><br><span class="line"><span class="string">                "url" : "http://www.example.com/path/to/file.ext"</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        //失败时</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">                "error" : 1,</span></span><br><span class="line"><span class="string">                "message" : "错误信息"</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">    <span class="keyword">return</span> JsonResponse(back_dic)</span><br></pre></td></tr></table></figure>

<p><code>backendbase.html</code></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">"en"</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">"UTF-8"</span>&gt;</span><br><span class="line">    &lt;meta name=<span class="string">"viewport"</span> content=<span class="string">"width=device-width, initial-scale=1"</span>&gt;</span><br><span class="line">    &lt;title&gt;后台管理&lt;/title&gt;</span><br><span class="line">    &lt;script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"&gt;&lt;/script&gt;</span><br><span class="line">    &lt;link rel=<span class="string">"stylesheet"</span> href=<span class="string">"/static/blog/bs/css/bootstrap.css"</span>&gt;</span><br><span class="line">    &lt;script src="/static/blog/bs/js/bootstrap.js"&gt;&lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;nav class="navbar navbar-inverse"&gt;</span><br><span class="line">    &lt;div class="container-fluid"&gt;</span><br><span class="line">        &lt;!-- Brand and toggle get grouped for better mobile display --&gt;</span><br><span class="line">        &lt;div class="navbar-header"&gt;</span><br><span class="line">            &lt;button type="button" class="navbar-toggle collapsed" data-toggle="collapse"</span><br><span class="line">                    data-target=<span class="string">"#bs-example-navbar-collapse-1"</span> aria-expanded=<span class="string">"false"</span>&gt;</span><br><span class="line">                &lt;span class="sr-only"&gt;Toggle navigation&lt;/span&gt;</span><br><span class="line">                &lt;span class="icon-bar"&gt;&lt;/span&gt;</span><br><span class="line">                &lt;span class="icon-bar"&gt;&lt;/span&gt;</span><br><span class="line">                &lt;span class="icon-bar"&gt;&lt;/span&gt;</span><br><span class="line">            &lt;/button&gt;</span><br><span class="line">            &lt;a class="navbar-brand" href="#"&gt;后台管理&lt;/a&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- Collect the nav links, forms, and other content for toggling --&gt;</span><br><span class="line">        &lt;div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1"&gt;</span><br><span class="line">            &lt;ul class="nav navbar-nav navbar-right"&gt;</span><br><span class="line">                &lt;li&gt;&lt;a href="#"&gt;&#123;&#123; request.user.username &#125;&#125;&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">            &lt;/ul&gt;</span><br><span class="line">        &lt;/div&gt;&lt;!-- /.navbar-collapse --&gt;</span><br><span class="line">    &lt;/div&gt;&lt;!-- /.container-fluid --&gt;</span><br><span class="line">&lt;/nav&gt;</span><br><span class="line">&lt;div class="container-fluid"&gt;</span><br><span class="line">    &lt;div class="row"&gt;</span><br><span class="line">        &lt;div class="col-md-2"&gt;</span><br><span class="line">            &lt;div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true"&gt;</span><br><span class="line">                &lt;div class="panel panel-default"&gt;</span><br><span class="line">                    &lt;div class="panel-heading" role="tab" id="headingOne"&gt;</span><br><span class="line">                        &lt;h4 class="panel-title"&gt;</span><br><span class="line">                            &lt;a role=<span class="string">"button"</span> data-toggle=<span class="string">"collapse"</span> data-parent=<span class="string">"#accordion"</span> href=<span class="string">"#collapseOne"</span></span><br><span class="line">                               aria-expanded=<span class="string">"true"</span> aria-controls=<span class="string">"collapseOne"</span>&gt;</span><br><span class="line">                                操作</span><br><span class="line">                            &lt;/a&gt;</span><br><span class="line">                        &lt;/h4&gt;</span><br><span class="line">                    &lt;/div&gt;</span><br><span class="line">                    &lt;div id="collapseOne" class="panel-collapse collapse in" role="tabpanel"</span><br><span class="line">                         aria-labelledby=<span class="string">"headingOne"</span>&gt;</span><br><span class="line">                        &lt;div class="panel-body"&gt;&lt;a href="/add_article/"&gt;添加文章&lt;/a&gt;&lt;/div&gt;</span><br><span class="line">                        &lt;div class="panel-body"&gt;&lt;a href="#"&gt;添加随笔&lt;/a&gt;&lt;/div&gt;</span><br><span class="line">                        &lt;div class="panel-body"&gt;&lt;a href="#"&gt;个人设置&lt;/a&gt;&lt;/div&gt;</span><br><span class="line">                        &lt;div class="panel-body"&gt;&lt;a href="#"&gt;文件搬家&lt;/a&gt;&lt;/div&gt;</span><br><span class="line">                    &lt;/div&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div class="col-md-10"&gt;</span><br><span class="line">            &lt;div&gt;</span><br><span class="line"></span><br><span class="line">                &lt;!-- Nav tabs --&gt;</span><br><span class="line">                &lt;ul class="nav nav-tabs" role="tablist"&gt;</span><br><span class="line">                    &lt;li role="presentation" class="active"&gt;&lt;a href="#home" aria-controls="home" role="tab"</span><br><span class="line">                                                              data-toggle="tab"&gt;文章&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">                    &lt;li role="presentation"&gt;&lt;a href="#profile" aria-controls="profile" role="tab" data-toggle="tab"&gt;随笔&lt;/a&gt;</span><br><span class="line">                    &lt;/li&gt;</span><br><span class="line">                    &lt;li role="presentation"&gt;&lt;a href="#messages" aria-controls="messages" role="tab" data-toggle="tab"&gt;设置&lt;/a&gt;</span><br><span class="line">                    &lt;/li&gt;</span><br><span class="line">                    &lt;li role="presentation"&gt;&lt;a href="#settings" aria-controls="settings" role="tab" data-toggle="tab"&gt;更多&lt;/a&gt;</span><br><span class="line">                    &lt;/li&gt;</span><br><span class="line">                &lt;/ul&gt;</span><br><span class="line"></span><br><span class="line">                &lt;!-- Tab panes --&gt;</span><br><span class="line">                &lt;div class="tab-content"&gt;</span><br><span class="line">                    &lt;div role="tabpanel" class="tab-pane active" id="home"&gt;</span><br><span class="line">                        &#123;% block css %&#125;</span><br><span class="line"></span><br><span class="line">                        &#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">                        &#123;% block content %&#125;</span><br><span class="line">                        </span><br><span class="line">                        &#123;% endblock %&#125;</span><br><span class="line">                    &lt;/div&gt;</span><br><span class="line">                    &lt;div role="tabpanel" class="tab-pane" id="profile"&gt;随笔页面&lt;/div&gt;</span><br><span class="line">                    &lt;div role="tabpanel" class="tab-pane" id="messages"&gt;设置页面&lt;/div&gt;</span><br><span class="line">                    &lt;div role="tabpanel" class="tab-pane" id="settings"&gt;更多页面&lt;/div&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p><code>backend.html</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;% extends <span class="string">'backend/backendbase.html'</span> %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">    &lt;table class="table table-hover table-striped"&gt;</span><br><span class="line">        &lt;thead&gt;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">            &lt;td&gt;标题&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;作者&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;评论&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;点赞&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;点踩&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;操作&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;操作&lt;/td&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">        &lt;/thead&gt;</span><br><span class="line">        &lt;tbody&gt;</span><br><span class="line">        &#123;% <span class="keyword">for</span> article <span class="keyword">in</span> page_queryset %&#125;</span><br><span class="line">            &lt;tr&gt;</span><br><span class="line">                &lt;th&gt;&lt;a href="/&#123;&#123; article.blog.userinfo.username &#125;&#125;/articles/&#123;&#123; article.pk &#125;&#125;"&gt;&#123;&#123; article.title &#125;&#125;&lt;/a&gt;&lt;/th&gt;</span><br><span class="line">                &lt;th&gt;&#123;&#123; article.blog.userinfo.username &#125;&#125;&lt;/th&gt;</span><br><span class="line">                &lt;th style="color: red;"&gt;&#123;&#123; article.comment_count &#125;&#125;&lt;/th&gt;</span><br><span class="line">                &lt;th&gt;&#123;&#123; article.up_count &#125;&#125;&lt;/th&gt;</span><br><span class="line">                &lt;th&gt;&#123;&#123; article.down_count &#125;&#125;&lt;/th&gt;</span><br><span class="line">                &lt;th&gt;&lt;a href="#"&gt;编辑&lt;/a&gt;&lt;/th&gt;</span><br><span class="line">                &lt;th&gt;&lt;a href="#"&gt;删除&lt;/a&gt;&lt;/th&gt;</span><br><span class="line">            &lt;/tr&gt;</span><br><span class="line">        &#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &lt;/tbody&gt;</span><br><span class="line">    &lt;/table&gt;</span><br><span class="line">    &#123;&#123; page_obj.page_html|safe &#125;&#125;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>

<p><code>add_article.html</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;% extends <span class="string">'backend/backendbase.html'</span> %&#125;</span><br><span class="line">&#123;% block css %&#125;</span><br><span class="line">    &lt;style&gt;</span><br><span class="line">        div.CollapsibleTitle &#123;</span><br><span class="line">            font-size: <span class="number">105</span>%;</span><br><span class="line">            background: <span class="comment">#E5EEF7;</span></span><br><span class="line">            border-top: <span class="number">1</span>px solid <span class="comment">#AAAAAA;</span></span><br><span class="line">            border-bottom: <span class="number">1</span>px dashed <span class="comment">#AAAAAA;</span></span><br><span class="line">            font-weight: bold;</span><br><span class="line">            color: <span class="comment">#333333;</span></span><br><span class="line">            width: auto;</span><br><span class="line">            padding: <span class="number">2</span>px <span class="number">12</span>px;</span><br><span class="line">            margin: <span class="number">12</span>px <span class="number">0</span>px <span class="number">5</span>px <span class="number">0</span>px;</span><br><span class="line">            clear: left;</span><br><span class="line">        &#125;</span><br><span class="line">    &lt;/style&gt;</span><br><span class="line"></span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">    &lt;div id="Editor_Edit_Header" class="CollapsibleTitle"&gt;</span><br><span class="line">        &lt;span id="Editor_Edit_headerTitle"&gt;添加文章&lt;/span&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;hr&gt;</span><br><span class="line">    &lt;form action=<span class="string">""</span> method=<span class="string">"post"</span>&gt;</span><br><span class="line">        &#123;% csrf_token %&#125;</span><br><span class="line">        &lt;h5&gt;标题&lt;/h5&gt;</span><br><span class="line">        &lt;input type="text" name="title" id="id_title" class="form-control"&gt;</span><br><span class="line">        &lt;p&gt;内容(kindeditor编辑器，支持拖放/粘贴上传图片)&lt;/p&gt;</span><br><span class="line">        &lt;p&gt;&lt;textarea name="content" id="id_content" cols="30" rows="10"&gt;&lt;/textarea&gt;&lt;/p&gt;</span><br><span class="line">        &lt;input type="submit" value="发布文章" class="btn btn-info"&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line"></span><br><span class="line">    &lt;script charset="utf-8" src="/static/kindeditor/kindeditor-all-min.js"&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script&gt;</span><br><span class="line">        KindEditor.ready(function (K) &#123;</span><br><span class="line">            window.editor = K.create(<span class="string">'#id_content'</span>, &#123;</span><br><span class="line">                width: <span class="string">'100%'</span>,</span><br><span class="line">                height: <span class="string">'700px'</span>,</span><br><span class="line">                resizeType: <span class="number">0</span>,</span><br><span class="line">                // 控制文件上传的位置</span><br><span class="line">                uploadJson: <span class="string">'/upload_img/'</span>,</span><br><span class="line">                extraFileUploadParams: &#123;</span><br><span class="line">                    <span class="string">'csrfmiddlewaretoken'</span>: <span class="string">'&#123;&#123; csrf_token &#125;&#125;'</span></span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>

</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Gorg Chen</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://cjwnb.top/2019/07/23/BBS项目/">http://cjwnb.top/2019/07/23/BBS项目/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://cjwnb.top">Gorg Chen</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/django/">django    </a><a class="post-meta__tags" href="/tags/项目/">项目    </a></div><div class="post_share"><div class="social-share" data-image="http://pic1.win4000.com/pic/2/59/d366d1f0e7.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-buttom"><i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lozad post-qr-code__img" data-src="/img/wechat.jpg"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lozad post-qr-code__img" data-src="/img/alipay.jpg"><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull-left"><a href="/2019/07/30/CRM项目之必备知识点/"><img class="prev_cover lozad" data-src="http://pic1.win4000.com/pic/1/dc/e2acd32b70.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>CRM项目之必备知识点</span></div></a></div><div class="next-post pull-right"><a href="/2019/07/22/session和cookie/"><img class="next_cover lozad" data-src="http://pic1.win4000.com/pic/b/c8/e9278727bf.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>Django操作session和cookie</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2019/07/16/图书管理系统/" title="图书管理系统"><img class="relatedPosts_cover lozad" data-src="http://pic1.win4000.com/wallpaper/2019-06-20/5d0af635960af.jpg"><div class="relatedPosts_title">图书管理系统</div></a></div><div class="relatedPosts_item"><a href="/2019/07/10/Django路由层之分组/" title="django 路由层之分组"><img class="relatedPosts_cover lozad" data-src="http://pic1.win4000.com/wallpaper/2019-04-26/5cc2d2fcaa092.jpg"><div class="relatedPosts_title">django 路由层之分组</div></a></div><div class="relatedPosts_item"><a href="/2019/07/20/ORM之查询/" title="ORM之查询"><img class="relatedPosts_cover lozad" data-src="http://pic1.win4000.com/pic/6/69/7f345f516e.jpg"><div class="relatedPosts_title">ORM之查询</div></a></div><div class="relatedPosts_item"><a href="/2019/08/06/Stark组件（四）列表页面自定义函数扩展/" title="Stark组件（四）列表页面自定义函数扩展"><img class="relatedPosts_cover lozad" data-src="http://pic1.win4000.com/pic/b/c8/e9278727bf.jpg"><div class="relatedPosts_title">Stark组件（四）列表页面自定义函数扩展</div></a></div><div class="relatedPosts_item"><a href="/2019/08/21/中间件/" title="中间件"><img class="relatedPosts_cover lozad" data-src="http://pic1.win4000.com/pic/6/69/7f345f516e.jpg"><div class="relatedPosts_title">中间件</div></a></div><div class="relatedPosts_item"><a href="/2019/08/05/Django中_Meta 部分用法/" title="Django中_Meta 部分用法"><img class="relatedPosts_cover lozad" data-src="http://pic1.win4000.com/pic/b/c8/e9278727bf.jpg"><div class="relatedPosts_title">Django中_Meta 部分用法</div></a></div></div><div class="clear_both"></div></div></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2018 - 2019 By Gorg Chen</div><div class="framework-info"><span>驱动 </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly"><span>Butterfly</span></a></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><section class="rightside" id="rightside"><i class="fa fa-book" id="readmode" title="阅读模式"> </i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换">簡</a><i class="fa fa-moon-o nightshift" id="nightshift" title="夜间模式"></i></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/nightshift.js"></script><script id="ribbon" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/js/piao.js"></script><script src="/js/tw_cn.js"></script><script>translateInitilization()

</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@1.2.2/instantpage.min.js" type="module"></script></body></html>